<html lang="en" ng-app="eimodule" ng-init="current_country_id='AGO'">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UNDP Extractive Industries Data Dive</title>

    <!-- Load c3.css Style -->
    <link href="css/c3.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap Style -->
    <link href="css/bootstrap.min.css" rel="stylesheet">  
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    
    <style>
    
    /*-------------------------------------------------------------------------        
      These override Bootstrap Styles
      -----------------------------------------------------------------------*/  

        .mybtn {
          margin-bottom: 5;
          margin-left: 5;
          margin-right: 5;
          background-color: #eee !important;
          border: 2px !important;
          border-color: #eee !important;
          border-style: solid !important;          
        }
        
        .mygroupselect {
          border: 1px solid #ccc; padding-left: 4px; padding-right: 4px; padding-top: 4px;
        }
        
        h2 {
           margin-top:5px; margin-bottom:5px;
        }
        h3 {
           margin-top:5px; margin-bottom:5px;
        }
        h5 {
           margin-top:5px; margin-bottom:2px;
        }
        .jumbotron {
          padding-top: 0;
          padding-bottom: 0;
          margin-bottom: 10;
          
        }
        h1 {
          font-size: 50px !important;
        }
        
        .smalltext {
          font-size: 11px !important;
        }  
        .btnsmalltext {
          font-size: 10px !important;
        }
        
        .legend {
          
        }
    /*-------------------------------------------------------------------------        
      These are used for highlighting countries. bf8c5a bb7c25
      -----------------------------------------------------------------------*/  

        .grouppaths {
          stroke: #5f5f5f !important; /*bf8c5a 2f2f2f 5f5f5f */ 
          stroke-width: 1.8 !important;
          stroke-opacity: 1 !important;  
        }

        .plainpaths {
          stroke: #ffffff !important;
          stroke-width: 1.4 !important;
          stroke-opacity: .1 !important;
        }
        
    /*-------------------------------------------------------------------------        
      These override c3 Styles
      -----------------------------------------------------------------------*/  
      
        #chart2 .c3-line-econ_gdpcon {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_gdpconpc {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_tax {
          stroke-width: 0px;
        }
        #chart2 .c3-line-rev_gov_resrev_govtrev {
          stroke-width: 4px;
          stroke-dasharray: 5,5;
        }
        #chart2 .c3-line-rev_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_nonresrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_rev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_rent_total_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_govt_take {
          stroke-width: 0px;
        } 

        .c3-axis-y path {
          stroke-width: 0px !important;
        }
        .c3-axis-y2 path {
          stroke-width: 0px !important;
        }
        /*
        .c3-axis-y line {
          stroke-width: 0px !important;
        }
        */
    /*-------------------------------------------------------------------------        
      Group Comparison Small Multiples
      -----------------------------------------------------------------------*/  
        /*
        #smallmult .line {
          fill: none;
          stroke-width: 1.5px;
        }
        
        #smallmult .area {
        }
        */
        
        div[id*='smallmult'] .line {
          fill: none;
          /*stroke: #666;*/
          stroke-width: 1.5px;
        }
        div[id*='smallmult'] .area {
          /*fill: #e7e7e7;*/
        }


        
    </style>

   
  </head>
  <body ng-controller="ei_countrySelect_control">

    <!-------------------------------------------------------------------------        
      Load Some Scripts We Need      
      ------------------------------------------------------------------------->

    <!-- For D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- For TopoJSON and DataMaps -->
    <script src='http://d3js.org/topojson.v1.min.js' type='text/javascript'></script>
    <script src='http://datamaps.github.io/scripts/datamaps.all.min.js' type='text/javascript'></script>
    <!-- Load c3.js -->
    <script src="js/c3.min.js"></script>
    
    <!--
    <script src="http://c3js.org/js/c3.min-631d1d50.js"></script>
    -->
    <!-- Load angular.js -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js' type='text/javascript'></script>
    <!-- ColorBrewer Colors -->
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Extractive Industries and Development</h1>
        <p>What is the relationship between extractive industry profitability and fiscal revenue from resources?</p>
      </div>
    </div>

    <!-------------------------------------------------------------------------        
      Define Page Layout
      
      This section uses bootstrap to create "cells" on the page for each visual-
      ization.  
      You can add rows, and columns within rows, at the end as needed 
      to accomodate more content.
      Within a cells, there may be a DIV that is a placeholder for a 
      visualization that is later generated by JavaScript
      ------------------------------------------------------------------------->
    
    <!-- Set up our Bootstrap Layout Grid -->
    <div class="container">
    <div class="row">
        <!--
        <div class="col-md-2 text-left">
          <h3>Natural Resources</h3>
          Resource dependence, resource wealth, and the distribution of resource wealth vary widely across countries.
           <p>Click on a country to see its data below.</p> 
           <p>Filled countries have resource data available.</p>
          <div class="btn-group btn-group-xs">
            <button class="btn btn-mini mybtn" ng-click="updateCurrentStat('default')">Reset Data Availability Fill</button>
          </div>
        </div>  
        -->
        <div class="col-md-8 text-left">
        
          <div class="row">
            <div class="col-md-12 text-left">
                <div id='chart1'  style="width: 700px;height: 300px;"></div>
            </div>
          </div>   
          <div class="row">
            <div class="col-md-12 text-left">                 
             Click a country on the map to select it and view its data. Click a button to select a country group and view its data. Click on the legend to fill the map by the statistic.
            </div>
          </div>  
          <div class="row">
            <div class="col-md-6 text-left mygroupselect">                 
                  <div class="smalltext" >              
                    Income
                     <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Low income')">Low</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Lower middle income')">Lower Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Upper middle income')">Upper Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'High income')">High</button>
                    </div>  
                  </div>
<!--                  
            </div>
            <div class="col-md-6 text-left mygroupselect">  
-->            
                  <div class="smalltext">              
                      Primary Rents
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Oil')">Oil</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Gas')">Gas</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Minerals')">Minerals</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Coal')">Coal</button>
                      </div>  
                  </div>
<!--                  
            </div>
          </div>  
          <div class="row">         
             <div class="col-md-6 text-left mygroupselect">                 
--> 
                  <div class="smalltext">              
                      Region
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Africa')">Africa</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Asia')">Asia</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Europe')">Europe</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Latin America and the Caribbean')">LAmer.&Carr.</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'North America')">North America</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Oceania')">Oceania</button>                        
                      </div>  
                  </div>
            </div>
            <div class="col-md-6 text-left mygroupselect">                 
             <div id="legend">
               
             </div>
            </div>
         </div>  
              <!--
              <div class="smalltext" style="border: 1px solid #ccc; padding-left: 4px; padding-right: 4px; display: inline">              
                Income
                 <div class="btn-group btn-group-xs">
                    <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Low income')">Low</button>
                    <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Lower middle income')">Lower Mid</button>
                    <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Upper middle income')">Upper Mid</button>
                    <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'High income')">High</button>
                </div>  
              </div>            
              -->
        </div>  <!-- 8 -->            
        
        <div class="col-md-4 text-left">
          <h3 ng-bind='current_selection_name'></h3>
          <div id='chart2'></div>        
        </div>
        
    </div> 
    </div>

 
    <!-------------------------------------------------------------------------        
      End Page Layout   
      From here on it is all JavaScript.
      ------------------------------------------------------------------------->


    <!-------------------------------------------------------------------------        
      Load Some More Scripts We Need    
      Documentation says we can do this at this point to decrease 
      page loading time.
      ------------------------------------------------------------------------->
      
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- <script src="http://code.jquery.com/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    
    <script>
    
    // -------------------------------------------------------------------------   
    // -------------------------------------------------------------------------      
    // Angular JavaScript Setup
    //
    // Note: this is not the ideal or best way to combine Angular and D3.
    // Right now all UI code is in the Angular controller.
    // Best way would be to wrap the UI code for each chart into their own
    // separate Angular Directive.  The Controller would take care of loading
    // the data and managing the events - mainly, updating the scope data
    // variables that each Directive then uses.  All the UI code would be
    // hidden behind the Directive's interface.
    // Just learning Angular, so staring with this initial implementation for 
    // now, hope to change in the future.
    // -------------------------------------------------------------------------
    // -------------------------------------------------------------------------      
    
  
    // -------------------------------------------------------------------------      
    // Create the Angular App - this is the root.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    
    // -------------------------------------------------------------------------      
    // Create Factory using our App.
    // Factory just wraps data retrieval method in this case.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    eimod.factory("eifactory", function($http) {
      var factory = {};    
      
      factory.getRawData = function() {
        return $http.get('eidata.json');      
      };  
      
    return factory;      
    });

    // -------------------------------------------------------------------------      
    // Create Controller using our App.
    // Controller holds all the business logic.
    // Controller has access to a $scope variable where we can store state.
    // -------------------------------------------------------------------------   
    eimod.controller("ei_countrySelect_control", function($scope, eifactory) {
      
      console.log("in controller");
      
      // -------------------------------------------------------------------------      
      // Initialize variables that will hold our data.
      // These vars sit on the $scope variable so all angular functions have
      // access to them.
      // FYI country data has been split into three variables for ease of use
      // 1) non-time-series data
      // 2) macro time-series data
      // 3) resource-related time-series data
      // -------------------------------------------------------------------------      
  
      // raw form that data is read in from file
      $scope.raw_data = [];
      //$scope.country_names = [];      
      
      // associative array (ccode is key) of non-time series country data
      $scope.country_data_json = [];
      // associative array (ccode is key) of time series macroeconomic data
      $scope.country_macro_stat_data_json = [];
      // associative array (ccode is key) of time series resource-related data
      $scope.country_resource_stat_data_json = [];      
      // associative array (ccode is key) of time series resource-related data
      // where the time series data is in an array format, not a JS object one
      // this is the format the c3 charts expect
      // same data as "country_resource_stat_data_json"
      $scope.country_resource_stat_data_arr = [];
      // name of the currently selected country
      $scope.current_country_name = "";
      // object that holds the default fill information for each country on 
      // the map 
      $scope.dataMapFillKeys = {};
      
      $scope.currentStat = "default";
      $scope.currentStatName = "";
 
      // stores our map and chart visualization variables
      $scope.chart1 = null;      
      $scope.chart2 = null;

      // array of years
      // this is necessary for the c3 charts
      var xaxis = ["x",2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012];
      
      // -------------------------------------------------------------------------      
      // This function is called when the JSON data has been loaded.
      // It does 2 things:
      // 1) Any needed data processing (before the page uses the dat).  Saves results
      //    in $scope variables declared above.
      // 2) Sets up & creates each chart, and saves the variable in $scope.
      // -------------------------------------------------------------------------            
       
      eifactory.getRawData().success(function(data) {
        
          console.log("in get data success");
  
          // save raw data
          $scope.raw_data = data;
          console.log("raw data: ");
          console.log($scope.raw_data);
          
    
          // take data out of raw data and puts into associative arrays
          // where it is easier for our charts to access          
          $scope.raw_data.forEach(function(countryObj, index) {
            $scope.country_data_json[countryObj.country.ccode] = countryObj.country;
            $scope.country_macro_stat_data_json[countryObj.country.ccode] = countryObj.macroStats;
            $scope.country_resource_stat_data_json[countryObj.country.ccode] = countryObj.resourceStats;            
          });           
          console.log("country json data: ");
          console.log($scope.country_data_json);  
          console.log("country macro stat json data: ");
          console.log($scope.country_macro_stat_data_json);  
          console.log("country resource stat json data: ");
          console.log($scope.country_resource_stat_data_json);  


          // this put the same resource data into array format
          // this is only necessary because c3 chart expects time series
          // data to come in this format.
          $scope.raw_data.forEach(function(countryObj, index) {
                       
            var statData = Object();
            $scope.country_resource_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(xaxis);
            
            for (var statname in countryObj.resourceStats) {
              //console.log(countryObj.resourceStats);
              //console.log(statname);
              var tmp=[];
              tmp.push(statname);
              statData[statname] = tmp.concat(countryObj.resourceStats[statname]);
              $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(statData[statname]);            
            }

          });
          console.log("country arr data: ");
          console.log($scope.country_resource_stat_data_arr);  
 
 
          // this creates the default fill keys for the map, based
          // on whether we have any resource data
          // this object will be passed to data map          
          for (countryObjKey in $scope.country_data_json) {
            $scope.dataMapFillKeys[countryObjKey] = {};
            if ($scope.country_data_json[countryObjKey].haveResourceStats == "1") {
              //console.log("has stats");
              $scope.dataMapFillKeys[countryObjKey].fillKey = "haveResourceStats";
            }  
            else   
              $scope.dataMapFillKeys[countryObjKey].fillKey = "defaultFill";  
          }
          console.log("dataMapFillKeys:");
          console.log($scope.dataMapFillKeys);
          
          $scope.group_resource_stat_data_json = {};
          $scope.group_resource_stat_data_arr = [];
          
                    
          // this calculates average data for groups of countries we are interested in
          // and stores it in an object
          var resourceStats = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          console.log("lookupfactors before loop");
          console.log(lookupfactors);
          
          lookupfactors.forEach(function(currentFactor, index) {
              console.log("in lookup loop");
              console.log(currentFactor);
              $scope.group_resource_stat_data_json[currentFactor.factor] = currentFactor;
              $scope.group_resource_stat_data_json[currentFactor.factor].alevels = {};
              
              $scope.group_resource_stat_data_arr[currentFactor.factor] = [];  
              
              currentFactor.levels.forEach(function(currentLevel, index) {
                console.log("currentLevel.level");
                
                console.log(currentLevel.level);
                
                $scope.group_resource_stat_data_json[currentFactor.factor].alevels[currentLevel.level] = currentLevel;
                
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level] = [];  
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(xaxis);  
                
                var countries = getCountriesInGroup($scope.country_data_json, currentFactor.factor, currentLevel.level); 
                //console.log(countries);
                
                resourceStats.forEach(function(currentStat, sindex) {
                  var timeseries = [];
                  //!! Coal
                  //if (countries == null)
                  
                  countries.forEach(function(currentCountry, iindex) {
                    timeseries.push($scope.country_resource_stat_data_json[currentCountry][currentStat])
                  });                          
                  var byyears = d3.transpose(timeseries);
                  //$scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level][currentStat] = [];
                  //$scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level][sindex] = [];                  
                  var tmp=[];
                  tmp.push(currentStat);
                  byyears.forEach(function(currentYear, index){
                    tmp.push(d3.mean(currentYear));
                    //$scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level][currentStat].push(d3.mean(currentYear));  
                  });
                  $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(tmp);                  
                });
              });                        
          });
          
          console.log("$scope.group_resource_stat_data_json");
          console.log($scope.group_resource_stat_data_json);
          console.log("$scope.group_resource_stat_data_arr");
          console.log($scope.group_resource_stat_data_arr);
                    
          $scope.current_selection_name = $scope.country_data_json[$scope.current_country_id]["name"];

      // -------------------------------------------------------------------------      
      // Create the c3 line chart for resource data
      // -------------------------------------------------------------------------      

          $scope.chart2 = c3.generate({
              
                  bindto: '#chart2',      
                  
                  size: {
                    height: 200,
                  },   
                  data: {
                    x: 'x',
                    columns: $scope.country_resource_stat_data_arr[$scope.current_country_id],
                    axes: { rev_gov_resrev_govtrev : 'y',calc_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_rev_gdp : 'y', calc_rent_total_gdp : 'y', calc_govt_take: 'y2' },
                    type: 'line',
                    types: {
                        calc_govt_take: 'area',
                    },
                    names: varnames, 
                    colors: varcolors, 
                    labels:false,
                  }, // data  
                  axis: {
                    y: {
                      max: 100,
                      min: 0,
                      padding: {top:0, bottom:5},
                      label: {
                        text: 'Percent',
                        position: 'outer-middle'
                      },                      
                    },
                    y2: { max: 1.4, 
                          min: 0, 
                          padding: {top:0, bottom:.2},
                          show: true,
                          label: {
                            text: 'Government Take Ratio',
                            position: 'outer-middle'
                          },
                        },
                    x: { min: 2000, max: 2011, 
                    }
                
                  }, // axis
              
                 legend: {
                    show: false
                  },
                  
          });// c3.generate
          
      // -------------------------------------------------------------------------      
      // Create the data map
      // -------------------------------------------------------------------------      
          
          
          
          $scope.chart1 = new Datamap({
              element: document.getElementById('chart1'),
              scope: "world",
              fills: {
                defaultFill: "#eee", //#eee
                haveResourceStats: "#bebebe", //#faa632 //a65628 ffbb78 a65628 //#a6a6a6 dataAvailable bebebe
              },
              data: $scope.dataMapFillKeys,              
              "done": function(datamap) {
                  console.log("in done");
                  //$scope.datamap = datamap;
                  console.log($scope.datamap);
                  datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography, data) {
                    //console.log("in on click datamap");
                    $scope.selectCountry(geography.id);
                    //$scope.current_country_id = geography.id;
                    //$scope.$apply();
                  });
              }, // done
              geographyConfig: {
                highlightOnHover: true,
                highlightFillColor: '#ff7f0e',
                //highlightBorderColor: '#ff7f0e',
                //highlightBorderWidth: 5,
              },
         }); // chart1 
          
        
      // -------------------------------------------------------------------------      
      // Update map and groups at same time
      // For map, should really be doing this intially, not updating it...
      // have to change later.
      // -------------------------------------------------------------------------      
          
        console.log($scope.currentStat);
        //$scope.updateGroupStat($scope.currentStat);
        $scope.updateCurrentStat($scope.currentStat);
        
        $scope.doLegend();
  
          
      }).error(function(err){
          throw(err);                     
      }); // getData


      // -------------------------------------------------------------------------      
      // "Listener" function that is called whenever the current_country_id is
      // changed.  When selection is made in datamap, datamap changes this variable
      // This updates the line chart
      // Have to check for nulls here becuase it is called right at the beginning,
      // before data is loaded
      // -------------------------------------------------------------------------                

    $scope.$watch('current_selection', function(newValue, oldValue) {
        console.log('watch current_selection newValue:');
        console.log(newValue);
        
        if ($scope.current_country_id == null) {
          var countries = getCountriesInGroup($scope.country_data_json, newValue.factor, newValue.level);
          if ($scope.chart1 != null) {
            $scope.selectOnMap(countries);
          } 
          if ($scope.group_resource_stat_data_json != null) {
            $scope.current_selection_name = newValue.level;          
          }
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.group_resource_stat_data_arr[newValue.factor][newValue.level] })
        } else {
          if ($scope.chart1 != null) $scope.selectOnMap(new Array(newValue));
        
          if ($scope.country_data_json[newValue] != null) {
            //console.log($scope.country_data_json[newValue]);
            $scope.current_selection_name = $scope.country_data_json[newValue]["name"];          
          }    
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.country_resource_stat_data_arr[newValue] });          
        }
    }, true); 
 

      // -------------------------------------------------------------------------      
      // These are Event functions that are called when the user clicks a button 
      // on the datamap to
      // highlight or fill by a different variable
      // -------------------------------------------------------------------------                

      $scope.doLegend = function() {
          var resourceStatNames = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          var resourceStatObjs = [];  
          
          resourceStatNames.forEach(function(stat, index) {
            var statObj = {};
            statObj.name = varnames[stat];
            statObj.color = varcolors[stat];            
            resourceStatObjs.push(statObj);
          });
          console.log("resourceStatObjs");
          console.log(resourceStatObjs);
        
          var width = $("#legend").width()
          console.log("width: " + width);
        
          //var resourceStatObjs = [2,4,5,6,7];  
                  
          var svg = d3.selectAll("#legend").append("svg")
          var legend = svg.selectAll("g")
            .data(resourceStatObjs)
              .enter().append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
  
          legend.append("rect")
            .attr("x", 0)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", function(d,i) { return d.color; });
  
          legend.append("text")
              .attr("x", 22)
              .attr("y", 9)
              .attr("dy", ".35em")
              .style("text-anchor", "start")
              .text(function(d) { return d.name; });      
      }

      $scope.updateGroupStat = function(cstat) {
        console.log("insmallmultiples for: " + cstat);
          $scope.setUpSmallMultiples("#smallmult1", cstat, "class_income", ["High income", "Upper middle income","Lower middle income", "Low income"]);
          $scope.setUpSmallMultiples("#smallmult2", cstat, "class_reg", ["Africa", "Asia","Europe","Latin America and the Caribbean","North America","Oceania"]);
          //$scope.setUpSmallMultiples("#smallmult3", cstat, "class_opec", ["0", "1"]);
          $scope.setUpSmallMultiples("#smallmult3", cstat, "prim_prod", ["Fuels", "Industrial","Iron&Ferrous Metal","Non-Ferrous Metal", "Precious Stone&Metal"]);
          $scope.setUpSmallMultiples("#smallmult4", cstat, "prim_rent", ["Oil", "Gas","Minerals", "Coal"]);        
      }


      $scope.selectCountry = function(country) {
        console.log("selecting country:" + country);
        $scope.current_country_id = country;
        $scope.current_group_id = null;
        $scope.current_selection = country;        
        $scope.$apply();        
      }
      $scope.selectGroup = function(group, value) {
        console.log("selecting group:" + group + " with value: " + value);
        $scope.current_country_id = null;
        $scope.current_group_id = {"factor": group, "level": value };
        $scope.current_selection = {"factor": group, "level": value };
       } // end ftn   
              
      $scope.selectOnMap = function(countries) {
        console.log("selecting countries");
        
        var svg = $scope.chart1.svg;
        
        for (countryObjKey in $scope.country_data_json) {
          svg
              .selectAll('.' + countryObjKey)
              .classed({'plainpaths':true,'grouppaths':false });  
        }
        countries.forEach(function(country, index) {
            svg
              .selectAll('.' + country)
              .classed({'plainpaths':false,'grouppaths':true });        
        });
      }
      
      
      $scope.updateCurrentStat = function(statName) {
        console.log("updating choro");
        
        if(statName == "default") {
          $scope.chart1.updateChoropleth($scope.dataMapFillKeys);
          //$scope.updateGroupStat(statName);
        }           
          else {
          $scope.currentStat = statName;
          $scope.currentStatName = varnames[statName];
          $scope.updateGroupStat(statName);
            
          var countryVals = {};
          countryVals = getTimeSeriesAverage($scope.currentStat);
          
          var vals = [];
          for(key in countryVals) {
            vals.push(countryVals[key]);
          }            
          
          var baseColor = d3.rgb(varcolors[statName]);
          var darkest = baseColor.darker().darker().darker();
          var lightest = baseColor.brighter().brighter().brighter();
          console.log(darkest.toString());
          console.log(lightest.toString());
          
          if (statName == "calc_govt_take") {
            lightest = "#dcccc9";
            darkest = "#54332d";
          }
          if (statName == "calc_gov_resrev_gdp") {
            lightest = "#bbd6e8"; //bbd6e8 8fbbd9
            darkest = "#12476c";
          }
          if (statName == "calc_rent_total_gdp") {
            lightest = "#f2bebe"; //bbd6e8 8fbbd9
            darkest = "#951b1c";
          }
          
          
                              
          var color = d3.scale.linear()
                       .domain([d3.min(vals),d3.max(vals)])
                       .range([lightest.toString(), darkest.toString()]); //faa632 #ffbb78 b28254
         
          var chloroVals = {};
          for(key in countryVals) {
            //console.log("Key" + key + " is = " + countryVals[key]);
            //console.log("color" + ": " + color(countryVals[key]));
            
            if (countryVals[key] == null) {
                chloroVals[key] = "#eee";
            }
            else
                chloroVals[key] = color(countryVals[key]);
          }
          $scope.chart1.updateChoropleth(chloroVals);
        }
        
      };

 
      // -------------------------------------------------------------------------      
      // Helper functions to manage user clicks.
      // -------------------------------------------------------------------------                

      function getTimeSeriesAverageByCountry(ccode, statname) {
        //console.log("getting avg" + statname);
        //console.log($scope.country_macro_stat_data_json[ccode]);
        if ($scope.country_macro_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_macro_stat_data_json[ccode][statname]);    
        }  
        else if ($scope.country_resource_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_resource_stat_data_json[ccode][statname]);                    
        }
        else 
          return null;            
      };              
      
      function getTimeSeriesAverage(statName) {
        var statData = {};
        for (countryObjKey in $scope.country_data_json) {
          statData[countryObjKey] = getTimeSeriesAverageByCountry(countryObjKey, statName);    
        }
        console.log(statData);
        return statData;
      };
              
      function getCountriesInGroup(data, group, value) {
        console.log("Getting countries in " + group + " that are " + value);
        var out = [];
        //console.log(d3.keys(data));
        var keys = d3.keys(data);
        
        keys.forEach(function(ccode, index) {
          //console.log(ccode);
          //console.log(data[ccode]);
          //console.log(data[ccode][group]);
          if(data[ccode][group] == value) out.push(ccode);
        });
        //console.log(out);
        return out;
      }
      
    }); // controller
    
    </script>
    
    <script>
    
      // ----------------------------------------------------------------------      
      // I would like to load this separately from a JSON file, but don't know
      // how to do two seperate JSON files.  For now I will put these
      // constants here.
      // ----------------------------------------------------------------------                
    
      console.log("loading lookup constants for variables");
      var varlookupvals = 
        [ {
           "variable": "calc_gov_resrev_gdp",
          "values": {
           "name": "Government Resource Revenue",
          "source": "Calculated: avg of REV$rev_gov_resrev_gdp and REV2$rev2_gov_resrev_gdp",
          "color": "1f77b4" 
          } 
          },{
           "variable": "calc_govt_take",
          "values": {
           "name": "Government Take",
          "source": "Calculated: calc_gov_resrev_gdp / calc_rent_total_gdp",
          "color": "8c564b", //#a6a6a6 ff7878 8c564b
          } 
          },{
           "variable": "econ_gdpcon",
          "values": {
           "name": "GDP (constant $)",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_gdpconpc",
          "values": {
           "name": "GDP per capita (constant $)",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_govexp",
          "values": {
           "name": "Government Expenditure",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_govrev",
          "values": {
           "name": "Government Revenue",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_invtotal",
          "values": {
           "name": "Value of Investments",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_tax",
          "values": {
           "name": "Government Tax Revenue",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "calc_rent_total_gdp",
          "values": {
           "name": "Total Rents",
          "source": "Calculated from RENT: sum of RENT$rent_min, RENT$rent_oil, RENT$rent_gas",
          "color": "d62728" 
          } 
          },{
           "variable": "rev_gov_resrev_gdp",
          "values": {
           "name": "Government Resource Revenue",
          "source": "Resource_Revenue",
          "color": "" 
          } 
          },{
           "variable": "rev_gov_resrev_govtrev",
          "values": {
           "name": "Government Resource Revenue as % Govt Rev",
          "source": "Resource_Revenue",
          "color": "2ca02c" 
          } 
          },{
           "variable": "rev2_gov_nonresrev_gdp",
          "values": {
           "name": "Government Non-Resource Revenue",
          "source": "Resource_Revenue2",
          "color": "9467bd" //9467bd 1f77b4
          } 
          },{
           "variable": "rev2_gov_resrev_gdp",
          "values": {
           "name": "Government Resource Revenue",
          "source": "Resource_Revenue2",
          "color": "" 
          } 
          },{
           "variable": "rev2_gov_rev_gdp",
          "values": {
           "name": "Total Government Revenue",
          "source": "Resource_Revenue2",
          "color": "bcbd22" //8c564b bcbd22
           }
           },{
           "variable": "class_income",
          "values": {
           "name": "Income Level",
          "source": "CountryClassification",
          "color": "" //9467bd 1f77b4
          } 
          },{
           "variable": "class_reg",
          "values": {
           "name": "Region",
          "source": "CountryClassification",
          "color": "" 
          } 
          },{
           "variable": "prim_prod",
          "values": {
           "name": "Primary Resource Produced",
          "source": "Production_Total",
          "color": "" //8c564b bcbd22
          }
          },{
           "variable": "prim_rent",
          "values": {
           "name": "Primary Rent Source",
          "source": "Rent",
          "color": "" //8c564b bcbd22
          }          
        } ];

        var varnames = {};
        var varcolors = {};

        //var c = d3.scale.category10();
        //var dataAvailable = c(0);
        var dataAvailable = "#ffbb78";
        varlookupvals.forEach(function(item, index) {
          //console.log(item);
          varnames[item.variable] = item.values.name;
          varcolors[item.variable] = "#".concat(item.values.color);
          //varcolors[item.variable] = c(item.variable);
        });
        //console.log(d3.keys(varnames));
        console.log(varcolors);
        
        var lookupfactors = [
          {
            "factor": "class_income",
            "name": "Income",
            "color": "",
            "levels": [ 
              { "level": "Low income", "dname":"Low", "code": "LINC" },
              { "level": "Lower middle income", "dname":"Lower Middle", "code": "LMINC" },
              { "level": "Upper middle income", "dname":"Upper Middle", "code": "UMINC" },
              { "level": "High income", "dname":"High", "code": "HINC" },   
            ]
          },
          {
            "factor": "class_reg",
            "name": "Region",
            "color": "",
            "levels": [ 
              { "level": "Africa", "dname":"Africa", "code": "AFR" },
              { "level": "Asia", "dname":"Asia", "code": "ASIA" },
              { "level": "Europe", "dname":"Europe", "code": "EUR" },
              { "level": "Latin America and the Caribbean", "dname":"LAmer.&Carr.", "code": "LAMERC" },   
              { "level": "North America", "dname":"NAmerica", "code": "NAMER" },   
              { "level": "Oceania", "dname":"Oceania", "code": "OCA" },   
            ]
          },
          {
            "factor": "prim_rent",
            "name": "Main Rent Source",
            "color": "",
            "levels": [ 
              { "level": "Oil", "dname":"Oil", "code": "OIL" },
              { "level": "Gas", "dname":"Gas", "code": "GAS" },
              { "level": "Coal", "dname":"Coal", "code": "COAL" },   
              { "level": "Minerals", "dname":"Minerals", "code": "MIN" },
            ]
          },
          {
            "factor": "class_opec",
            "name": "OPEC",
            "color": "",
            "levels": [ 
              { "level": "OPEC", "dname":"Member", "code": "OPEC" },
              { "level": "Non-OPEC", "dname":"Non-Member", "code": "NOPEC" },
            ]
          },         
        ];
        
        console.log("lookupfactors");                
        console.log(lookupfactors);
        //console.log(c("calc_govt_take"));
        
      
    </script>

  </body>
</html>