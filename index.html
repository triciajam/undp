<html lang="en" ng-app="eimodule" ng-init="current_country_id='AGO'">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UNDP Extractive Industries Data Dive</title>

    <!-- Load c3.css Style -->
    <link href="css/c3.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap Style -->
    <link href="css/bootstrap.min.css" rel="stylesheet">  
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    
    <style>
    
        text {
          cursor: default;
        }
        .legend:hover {
          opacity:.5;
        }
        .heatrowlabel:hover {
          opacity:.5;
        }
    
    /*-------------------------------------------------------------------------        
      These override Bootstrap Styles
      -----------------------------------------------------------------------*/  

        .mybtn {
          margin-bottom: 5;
          padding-left: 2px !important;
          padding-right: 2px !important;
          margin-left: 2px !important;
          margin-right: 2px !important;
          background-color: #eee !important;
          border: 2px !important;
          border-color: #eee !important;
          border-style: solid !important;          
        }
        
        .mygroupselect {
          border: 1px solid #ccc; 
          padding-left: 0px; padding-right: 0px; padding-top: 0px;
        }
        .mycol {
          padding-left: 1px; padding-right: 1px; padding-top: 1px;
        }
        h2 {
           margin-top:5px; margin-bottom:5px;
        }
        h3 {
           margin-top:5px; margin-bottom:5px;
        }
        h4 {
           margin-top:2px; margin-bottom:2px; font-family: Consolas, courier;

        }
        .jumbotron {
          padding-top: 0;
          padding-bottom: 0;
          margin-bottom: 10;
          
        }
        h1 {
          font-size: 50px !important;
        }
        
        .smalltext {
          font-size: 10px !important;
        }  
        .medtext {
          font-size: 12px !important;
        } 
        .datatext {
          font-family: Consolas, courier;
          font-size: 11px;
          display: inline
        }         
        
        .btnsmalltext {
          font-family: Consolas, courier !important;
          font-size: 9px !important;
        }        
        
        .legend {
          
        }
    /*-------------------------------------------------------------------------        
      These are used for highlighting countries. bf8c5a bb7c25
      -----------------------------------------------------------------------*/  

        .grouppaths {
          stroke: #5f5f5f !important; /*bf8c5a 2f2f2f 5f5f5f */ 
          stroke-width: 1.8 !important;
          stroke-opacity: 1 !important;  
        }

        .plainpaths {
          stroke: #ffffff !important;
          stroke-width: 1.8 !important;
          stroke-opacity: .1 !important;
        }
        
    /*-------------------------------------------------------------------------        
      These override c3 Styles
      -----------------------------------------------------------------------*/  
      
        #chart2 .c3-line-econ_gdpcon {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_gdpconpc {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_tax {
          stroke-width: 0px;
        }
        #chart2 .c3-line-rev_gov_resrev_govtrev {
          stroke-width: 4px;
          stroke-dasharray: 5,5;
        }
        #chart2 .c3-line-rev_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_nonresrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_rev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_rent_total_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_govt_take {
          stroke-width: 0px;
        } 

        .c3-axis-y path {
          stroke-width: 0px !important;
        }
        .c3-axis-y2 path {
          stroke-width: 0px !important;
        }
        /*
        .c3-axis-y line {
          stroke-width: 0px !important;
        }
        */
        div[id*='Compare'] .c3-circle {
          fill: none !important;
        }
        div[id*='Compare'] .c3-line {
          stroke-width: 3px !important;
        }
        div[id*='Compare'] .c3-axis-x path {
          stroke-width: 0px !important;
        }
        
        div[id*='Compare'] .c3-legend-item {
          font-family: Consolas, courier !important;
          font-size: 11px !important;
        }
    /*-------------------------------------------------------------------------        
      Group Comparison Small Multiples
      -----------------------------------------------------------------------*/  
        
        div[id*='smallmult'] .line {
          fill: none;
          /*stroke: #666;*/
          stroke-width: 1.5px;
        }
        div[id*='smallmult'] .area {
          /*fill: #e7e7e7;*/
        }
        /*
        div[id*='stat-'] {
          fill: none;
          stroke-width: 1.5px;
        }
        */
        .statunselected {
          text-anchor: start;
          font-family: Consolas, courier;
          font-size: 11px;
          fill: #bebebe;          
        }
        .heatcountrylabel, .heatrowlabel {
          text-anchor: start;
          font-family: Consolas, courier;
          font-size: 11px;
          fill: #bebebe;          
        }
        /*#stat:hover { fill: "red" !important; };*/
        
    </style>

   
  </head>
  <body ng-controller="ei_countrySelect_control">

    <!-------------------------------------------------------------------------        
      Load Some Scripts We Need      
      ------------------------------------------------------------------------->

    <!-- For D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- For TopoJSON and DataMaps -->
    <script src='http://d3js.org/topojson.v1.min.js' type='text/javascript'></script>
    <script src='http://datamaps.github.io/scripts/datamaps.all.min.js' type='text/javascript'></script>
    <!-- Load c3.js -->
    <script src="js/c3.min.js"></script>
    
    <!--
    <script src="http://c3js.org/js/c3.min-631d1d50.js"></script>
    -->
    <!-- Load angular.js -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js' type='text/javascript'></script>
    <!-- ColorBrewer Colors -->
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Extractive Industries and Development</h1>
        <p>What is the relationship between extractive industry profitability and fiscal revenue from resources?</p>
      </div>
    </div>

    <!-------------------------------------------------------------------------        
      Define Page Layout
      
      This section uses bootstrap to create "cells" on the page for each visual-
      ization.  
      You can add rows, and columns within rows, at the end as needed 
      to accomodate more content.
      Within a cells, there may be a DIV that is a placeholder for a 
      visualization that is later generated by JavaScript
      ------------------------------------------------------------------------->
    
    <!-- Set up our Bootstrap Layout Grid -->
    <div class="container">
      <div class="row" style="padding-bottom:3px;">
            <div class="col-md-12 text-left mycol medtext">
              <h6 style="display:inline;padding-top:0px;margin-top:0px;margin-bottom:2px">Select</h6> 
              a country by clicking on the map, or  
              a group of countries by clicking its group.                
              <h6 style="display:inline;padding-top:0px;margin-top:0px;margin-bottom:2px">Choose</h6>
              a statistic to color countries according to their average value for that statistic across all years for which there is reported data.  
              Darker colors indicate higher average values.
              Government Take is Government Resource Revenue / Total Rents.
              All other statistics are given as %GDP, unless noted. <br>               
            </div>
      </div>  
      <div class="row">        
        <div class="col-md-8 text-left"> 
          <div class="row">
            <div class="col-md-12 text-left mycol">
                  <div class="datatext">              
                    Income
                     <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Low income')">Low</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Lower middle income')">Lower Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Upper middle income')">Upper Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'High income')">High</button>
                    </div>  
                  </div>
                  <div class="datatext">              
                      Region
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Africa')">Africa</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Asia')">Asia</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Europe')">Europe</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Latin America and the Caribbean')">LAmer&Carr</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'North America')">NAmerica</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Oceania')">Oceania</button>                        
                      </div>  
                  </div>
                  <div class="datatext">              
                      Rent
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Oil')">Oil</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Gas')">Gas</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Minerals')">Mineral</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Coal')">Coal</button>
                      </div>  
                  </div>                  
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 text-left mycol">
                <div id='chart1'  style="height: 320px;"></div>
            </div>
          </div>  
        </div>  <!-- end first column -->            
        
        <div class="col-md-4 text-center">
          <h4 ng-bind='current_selection_name'></h4>
          <div id='chart2'></div> 
        </div>
        
      </div> <!-- end big row -->
      
      <div class="row">
        <div class="col-md-12 text-left mycol medtext">
           <h5 style="display:inline;">Compare <span ng-bind='current_statistic_name'></span></h5> across groups of countries.  
           Yearly values are the average of all countries within the group reporting data for that year.  Click the group to add/remove its line.
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-4 text-center mycol">
          <div class="datatext">by Income</div>
          <div id="incomeCompare"></div>
        </div>
        <div class="col-md-4 text-center mycol">
          <div class="datatext">by Region</div>
          <div id="regionCompare"></div>
        </div>
        <div class="col-md-4 text-center mycol">
          <div class="datatext">by Primary Rent Source</div>
          <div id="rentCompare"></div>
        </div>            
      </div>
  
      <div class="row">
        <div class="col-md-12 text-left mycol medtext">
           <h5 style="display:inline;">Compare <span ng-bind='current_statistic_name'></span></h5> between countries.  
           The currently selected country or group of countries is highlighted.
           Click a year to sort countries by values for that year.
           Hover over a square to see actual values.
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-12 text-left mycol">
          <div id="heat2"></div>          
        </div>
      </div>
    </div> <!-- end container -->

 
    <!-------------------------------------------------------------------------        
      End Page Layout   
      From here on it is all JavaScript.
      ------------------------------------------------------------------------->


    <!-------------------------------------------------------------------------        
      Load Some More Scripts We Need    
      Documentation says we can do this at this point to decrease 
      page loading time.
      ------------------------------------------------------------------------->
      
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- <script src="http://code.jquery.com/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    
    <script>
    
    // -------------------------------------------------------------------------   
    // -------------------------------------------------------------------------      
    // Angular JavaScript Setup
    //
    // Note: this is not the ideal or best way to combine Angular and D3.
    // Right now all UI code is in the Angular controller.
    // Best way would be to wrap the UI code for each chart into their own
    // separate Angular Directive.  The Controller would take care of loading
    // the data and managing the events - mainly, updating the scope data
    // variables that each Directive then uses.  All the UI code would be
    // hidden behind the Directive's interface.
    // Just learning Angular, so staring with this initial implementation for 
    // now, hope to change in the future.
    // -------------------------------------------------------------------------
    // -------------------------------------------------------------------------      
    
  
    // -------------------------------------------------------------------------      
    // Create the Angular App - this is the root.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    
    // -------------------------------------------------------------------------      
    // Create Factory using our App.
    // Factory just wraps data retrieval method in this case.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    eimod.factory("eifactory", function($http) {
      var factory = {};    
      
      factory.getRawData = function() {
        return $http.get('eidata.json');      
      };  
      
    return factory;      
    });

    // -------------------------------------------------------------------------      
    // Create Controller using our App.
    // Controller holds all the business logic.
    // Controller has access to a $scope variable where we can store state.
    // -------------------------------------------------------------------------   
    eimod.controller("ei_countrySelect_control", function($scope, eifactory) {
      
      console.log("in controller");
      
      // -------------------------------------------------------------------------      
      // Initialize variables that will hold our data.
      // These vars sit on the $scope variable so all angular functions have
      // access to them.
      // FYI country data has been split into three variables for ease of use
      // 1) non-time-series data
      // 2) macro time-series data
      // 3) resource-related time-series data
      // -------------------------------------------------------------------------      
  
      // raw form that data is read in from file
      $scope.raw_data = [];
      //$scope.country_names = [];      
      
      // associative array (ccode is key) of non-time series country data
      $scope.country_data_json = [];
      // associative array (ccode is key) of time series macroeconomic data
      $scope.country_macro_stat_data_json = [];
      // associative array (ccode is key) of time series resource-related data
      $scope.country_resource_stat_data_json = [];      
      // associative array (ccode is key) of time series resource-related data
      // where the time series data is in an array format, not a JS object one
      // this is the format the c3 charts expect
      // same data as "country_resource_stat_data_json"
      $scope.country_resource_stat_data_arr = [];
      // name of the currently selected country
      $scope.current_country_name = "";
      // object that holds the default fill information for each country on 
      // the map 
      $scope.dataMapFillKeys = {};
      
      $scope.current_statistic_name = "";
 
      // stores our map and chart visualization variables
      $scope.chart1 = null;      
      $scope.chart2 = null;
      $scope.levelsCompareChart = {};
      
      $scope.initDone = false;
      
      // array of years
      // this is necessary for the c3 charts
      var xaxis = ["x",2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012];
      
      // -------------------------------------------------------------------------      
      // This function is called when the JSON data has been loaded.
      // It does 2 things:
      // 1) Any needed data processing (before the page uses the dat).  Saves results
      //    in $scope variables declared above.
      // 2) Sets up & creates each chart, and saves the variable in $scope.
      // -------------------------------------------------------------------------            
       
      eifactory.getRawData().success(function(data) {
        
          console.log("in get data success");
  
          // save raw data
          $scope.raw_data = data;
          //console.log("raw data: ");
          //console.log($scope.raw_data);
          
    
          // take data out of raw data and puts into associative arrays
          // where it is easier for our charts to access          
          $scope.raw_data.forEach(function(countryObj, index) {
            $scope.country_data_json[countryObj.country.ccode] = countryObj.country;
            $scope.country_macro_stat_data_json[countryObj.country.ccode] = countryObj.macroStats;
            $scope.country_resource_stat_data_json[countryObj.country.ccode] = countryObj.resourceStats;            
          });           
          console.log("country json data: ");
          console.log($scope.country_data_json);  
          console.log("country macro stat json data: ");
          console.log($scope.country_macro_stat_data_json);  
          console.log("country resource stat json data: ");
          console.log($scope.country_resource_stat_data_json);  


          // this put the same resource data into array format
          // this is only necessary because c3 chart expects time series
          // data to come in this format.
          $scope.raw_data.forEach(function(countryObj, index) {
                       
            var statData = Object();
            $scope.country_resource_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(xaxis);
            
            for (var statname in countryObj.resourceStats) {
              //console.log(countryObj.resourceStats);
              //console.log(statname);
              var tmp=[];
              tmp.push(statname);
              statData[statname] = tmp.concat(countryObj.resourceStats[statname]);
              $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(statData[statname]);            
            }

          });
          console.log("country arr data: ");
          console.log($scope.country_resource_stat_data_arr);  
 
 
          // this creates the default fill keys for the map, based
          // on whether we have any resource data
          // this object will be passed to data map          
          for (countryObjKey in $scope.country_data_json) {
            $scope.dataMapFillKeys[countryObjKey] = {};
            if ($scope.country_data_json[countryObjKey].haveResourceStats == "1") {
              //console.log("has stats");
              $scope.dataMapFillKeys[countryObjKey].fillKey = "haveResourceStats";
            }  
            else   
              $scope.dataMapFillKeys[countryObjKey].fillKey = "defaultFill";  
          }
          console.log("dataMapFillKeys:");
          console.log($scope.dataMapFillKeys);
          
          $scope.group_resource_stat_data_json = {};
          $scope.group_resource_stat_data_arr = [];
          
                    
          // this calculates average data for groups of countries we are interested in
          // and stores it in an object
          var resourceStats = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          
          lookupfactors.forEach(function(currentFactor, index) {
              console.log("in lookup loop");
              console.log(currentFactor);
              
              // have to make a copy of currentFactor explicitly or Javascript will point to same ref
              $scope.group_resource_stat_data_json[currentFactor.factor] = new Object();
              $scope.group_resource_stat_data_json[currentFactor.factor]["factor"] = currentFactor.factor;
              $scope.group_resource_stat_data_json[currentFactor.factor]["name"] = currentFactor.name;
              $scope.group_resource_stat_data_json[currentFactor.factor]["color"] = currentFactor.color;              
              $scope.group_resource_stat_data_json[currentFactor.factor].levels = [];
              
              $scope.group_resource_stat_data_arr[currentFactor.factor] = [];  
              
              currentFactor.levels.forEach(function(currentLevel, index) {
                console.log("currentLevel.level");
                
                console.log(currentLevel.level);
                
                $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level] = currentLevel;
                $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level].stats = [];                
                
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level] = [];  
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(xaxis);  
                
                var countries = getCountriesInGroup($scope.country_data_json, currentFactor.factor, currentLevel.level); 
                //console.log(countries);
                
                resourceStats.forEach(function(currentStat, sindex) {
                  var timeseries = [];
                  //!! Coal
                  //if (countries == null)
                  
                  countries.forEach(function(currentCountry, iindex) {
                    timeseries.push($scope.country_resource_stat_data_json[currentCountry][currentStat])
                  });                          
                  var byyears = d3.transpose(timeseries);
                  var tmp=[];
                  tmp.push(currentStat);
                  byyears.forEach(function(currentYear, index){
                    tmp.push(d3.mean(currentYear));
                  });
                  $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level].stats[currentStat] = tmp;
                  $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(tmp);                  
                });
              });                        
          });
          
          console.log("$scope.group_resource_stat_data_json");
          console.log($scope.group_resource_stat_data_json);
          console.log("$scope.group_resource_stat_data_arr");
          console.log($scope.group_resource_stat_data_arr);
                    
          $scope.current_selection_name = $scope.country_data_json[$scope.current_country_id]["name"];

      // -------------------------------------------------------------------------      
      // Create the c3 line chart for resource data
      // -------------------------------------------------------------------------      

          $scope.chart2 = c3.generate({
              
                  bindto: '#chart2',      
                  
                  size: {
                    height: 150,
                  },   
                  data: {
                    x: 'x',
                    columns: $scope.country_resource_stat_data_arr[$scope.current_country_id],
                    axes: { rev_gov_resrev_govtrev : 'y',calc_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_rev_gdp : 'y', calc_rent_total_gdp : 'y', calc_govt_take: 'y2' },
                    type: 'line',
                    types: {
                        calc_govt_take: 'area',
                    },
                    names: varnames, 
                    colors: varcolors, 
                    labels:false,
                  }, // data  
                  axis: {
                    y: {
                      max: 100,
                      min: 0,
                      padding: {top:0, bottom:5},
                      label: {
                        text: 'Percent',
                        position: 'outer-middle'
                      },                      
                    },
                    y2: { max: 1.4, 
                          min: 0, 
                          padding: {top:0, bottom:.2},
                          show: true,
                          label: {
                            text: 'Government Take Ratio',
                            position: 'outer-middle'
                          },
                        },
                    x: { min: 2000, max: 2011,  
                    }
                
                  }, // axis
              
                 legend: {
                    show: false
                  },
                  
          });// c3.generate
          
      // -------------------------------------------------------------------------      
      // Create the data map
      // -------------------------------------------------------------------------      
          
          console.log("p width " + $("#chart1").parent().width());
          
          $scope.chart1 = new Datamap({
              element: document.getElementById('chart1'),
              scope: "world",
              fills: {
                defaultFill: "#eee", //#eee
                haveResourceStats: "#bebebe", //#faa632 //a65628 ffbb78 a65628 //#a6a6a6 dataAvailable bebebe
              },
              data: $scope.dataMapFillKeys,              
              "done": function(datamap) {
                  console.log("in done");
                  //$scope.datamap = datamap;
                  console.log($scope.datamap);
                  datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography, data) {
                    //console.log("in on click datamap");
                    $scope.selectCountry(geography.id);
                    //$scope.current_country_id = geography.id;
                    //$scope.$apply();
                  });
              }, // done
              geographyConfig: {
                highlightOnHover: true,
                highlightFillColor: '#ff7f0e',
                //highlightBorderColor: '#ff7f0e',
                //highlightBorderWidth: 5,
              },
              "setProjection":   function(element) {
              var projection = d3.geo.equirectangular()
                     .scale(125)
                     .center([42, -26])
                     .rotate([-10,0])
              
                       var path = d3.geo.path()
                         .projection(projection);
                       
                       return {path: path, projection: projection}; 
               },
         }); // chart1 
          
        $scope.chart1.addPlugin('legendPlugin', function( layer, data, options ) {
          var self = this;
          options = options || {};
          data = data || {};
          
          var className = 'mylegend';
          console.log("calling new legend plug in");
          $scope.doLegend(this, layer);
  
        });
        $scope.chart1.addPlugin('groupSelectPlugin', function( layer, data, options ) {
          var self = this;
          options = options || {};
          data = data || {};
          
          var className = 'mylegend';
          console.log("calling new legend plug in");
          $scope.doGroup(this, layer);
  
        });
        
        
        //console.log($scope.current_statistic);
        //$scope.updateGroupStat($scope.current_statistic);
        //$scope.selectStatistic($scope.current_statistic);
        $scope.current_statistic = "calc_govt_take";
        $scope.current_statistic_name = varnames[$scope.current_statistic];

        console.log("adding legend plug in");
        $scope.chart1.legendPlugin();
          
        
      // -------------------------------------------------------------------------      
      // Set up other charts
      // -------------------------------------------------------------------------      
        
        //$scope.doLegend();
        
      // -------------------------------------------------------------------------      
      // Lien charts to compare levels of different factors
      // -------------------------------------------------------------------------      
        
        $scope.setupLevelsCompare("#incomeCompare", "class_income", $scope.current_statistic);        
        $scope.setupLevelsCompare("#regionCompare", "class_reg", $scope.current_statistic);
        $scope.setupLevelsCompare("#rentCompare", "prim_rent", $scope.current_statistic);
        
  
      // -------------------------------------------------------------------------      
      // Heatmap to compare countries
      // -------------------------------------------------------------------------      
        $scope.heatmap = new Heatmap("#heat2", xaxis.slice(1, xaxis.length-1));
        $scope.heatmap.setupData("calc_govt_take");
        $scope.heatmap.setupChart();
        $scope.heatmap.drawChart();
        $scope.heatmap.selectCountries(new Array($scope.current_country_id));
        
        $scope.initDone = true;
          
      }).error(function(err){
          throw(err);                     
      }); // getData


      // -------------------------------------------------------------------------      
      // "Listener" function that is called whenever the current_country_id is
      // changed.  When selection is made in datamap, datamap changes this variable
      // This updates the line chart
      // Have to check for nulls here becuase it is called right at the beginning,
      // before data is loaded
      // -------------------------------------------------------------------------                

    $scope.$watch('current_statistic', function(newValue, oldValue) {
        console.log('watch current_statistic newValue:');
        console.log(newValue);
        
        if (!$scope.initDone) return;
        $scope.current_statistic_name = varnames[newValue];
        
        if(newValue == "default") {
          if ($scope.chart1 != null) $scope.chart1.updateChoropleth($scope.dataMapFillKeys);
          //$scope.updateGroupStat(statName);
        }           
          else {
          //$scope.current_statistic = statName;
          
          //$scope.updateGroupStat(statName);
            
          var countryVals = {};
          countryVals = getTimeSeriesAverage(newValue);
          
          var vals = [];
          for(key in countryVals) {
            vals.push(countryVals[key]);
          }            
          
          var color = d3.scale.linear()
                       .domain([d3.min(vals),d3.max(vals)])
                       .range([varlookup[newValue].lightColor, varlookup[newValue].darkColor]); //faa632 #ffbb78 b28254
         
          var chloroVals = {};
          for(key in countryVals) {
            //console.log("Key" + key + " is = " + countryVals[key]);
            //console.log("color" + ": " + color(countryVals[key]));
            
            if (countryVals[key] == null) {
                chloroVals[key] = "#eee";
            }
            else
                chloroVals[key] = color(countryVals[key]);
          }
          if ($scope.chart1 != null) $scope.chart1.updateChoropleth(chloroVals);
        }
        if ($scope.heatmap != null) $scope.heatmap.updateChart(newValue, null);
        
        if ($scope.levelsCompareChart != null) {
          $scope.updateLevelsCompare("#incomeCompare", "class_income", newValue);
          $scope.updateLevelsCompare("#regionCompare", "class_reg", newValue);
          $scope.updateLevelsCompare("#rentCompare", "prim_rent", newValue);          
        }
                   
    }, true);

    $scope.$watch('current_selection', function(newValue, oldValue) {
        console.log('watch current_selection newValue:');
        console.log(newValue);
        
        var countries;
        
        if ($scope.current_country_id == null) {
          countries = getCountriesInGroup($scope.country_data_json, newValue.factor, newValue.level);
          if ($scope.chart1 != null) {
            $scope.selectOnMap(countries);
          } 
          if ($scope.group_resource_stat_data_json != null) {
            $scope.current_selection_name = newValue.level;          
          }
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.group_resource_stat_data_arr[newValue.factor][newValue.level] })
        } else {
          countries = new Array(newValue);
          if ($scope.chart1 != null) $scope.selectOnMap(countries);
        
          if ($scope.country_data_json[newValue] != null) {
            //console.log($scope.country_data_json[newValue]);
            $scope.current_selection_name = $scope.country_data_json[newValue]["name"];          
          }    
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.country_resource_stat_data_arr[newValue] });          
        }
        
        if ($scope.heatmap != null) $scope.heatmap.selectCountries(countries);
        
    }, true); 
 

      // -------------------------------------------------------------------------      
      // These are Event functions that are called when the user clicks a button 
      // on the datamap to
      // highlight or fill by a different variable
      // -------------------------------------------------------------------------                

      $scope.doLegend = function(map, layer) {
        
          console.log("in do legend2");
        
          var resourceStatNames = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          var resourceStatObjs = [];  
          
          resourceStatNames.forEach(function(stat, index) {
            var statObj = {};
            statObj.variable = stat;
            statObj.name = varnames[stat];
            statObj.color = varcolors[stat]; 
            statObj.selected = false;
            statObj.order = varlookup[stat].order;
            resourceStatObjs.push(statObj);
          });
          resourceStatObjs.sort(function(a, b) { return d3.ascending(a.order, b.order); });
          console.log("resourceStatObjs");
          console.log(resourceStatObjs);
        
          //var width = $("#legend").width()
          //console.log("width: " + width);
          
          var labelStartCoodinates = map.projection([-168, 12]);
 
          
        
          //var resourceStatObjs = [2,4,5,6,7];  
                  
          //var svg = d3.selectAll("#legend").append("svg")
          //var svg = layer.append("svg")
          /*
          var svg = layer.append("div")
            .attr("id", "legend")          
              .attr("x", labelStartCoodinates[0])
              .attr("y", labelStartCoodinates[1])
          
            //.attr("width", $("#legend").width())
            .attr("width", 400)
            .attr("height", 300);            
          */
          //layer
          //    .attr("x", labelStartCoodinates[0])
          //    .attr("y", labelStartCoodinates[1]);
          layer.attr("transform", function(d, i) { return "translate(" + labelStartCoodinates[0] + "," + labelStartCoodinates[1] + ")" });  
          /*
          layer.append("text")
              .attr("x", 0)
              .attr("y", 0)
              .attr("class", "medtext")              
                .text("Text that describes what to do");  
          */
          var legend = layer.selectAll("g")
            .data(resourceStatObjs)
              //.sort(function(a,b) {  console.log("this is a: " + a.order); return d3.descending(a.order, b.order); })
              .enter()
              .append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(0," + i * 14 + ")"; });
              //.attr("transform", function(d, i) { return "translate(" + labelStartCoodinates[0] + "," + labelStartCoodinates[1] + i * 14 + ")"; });
  
          //var legend = layer.
  
          legend.append("rect")
            .attr("x", 0)
            .attr("width", 10)
            .attr("height", 10)
            .style("fill", function(d,i) { return d.color; });
  
          legend.append("text")
              .attr("x", 14)
              .attr("y", 5)
              .attr("dy", ".35em")              
              .attr("class", "statunselected")      
              .style("fill", function(d,i) { return ($scope.current_statistic == d.variable) ? d.color : "#bebebe"; })
              .text(function(d) { return d.name; })
              .on("click", function(d, i) { 
                  legend.selectAll(".statunselected").style("fill", "#bebebe");
                  d3.select(this).style("fill", function(d) { return d.color; });
                  $scope.selectStatistic(d.variable);
              })
      }

      /*
      $scope.doLegend = function() {

          var resourceStatNames = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          var resourceStatObjs = [];  
          
          resourceStatNames.forEach(function(stat, index) {
            var statObj = {};
            statObj.variable = stat;
            statObj.name = varnames[stat];
            statObj.color = varcolors[stat]; 
            statObj.selected = false;
            resourceStatObjs.push(statObj);
          });
          console.log("resourceStatObjs");
          console.log(resourceStatObjs);
        
          var width = $("#legend").width()
          console.log("width: " + width);
        
          //var resourceStatObjs = [2,4,5,6,7];  
                  
          //var svg = d3.selectAll("#legend").append("svg")
          var svg = d3.selectAll("#legend").append("svg")
            //.attr("width", $("#legend").width())
            .attr("width", 200)
            .attr("height", 90);            
          
          var legend = svg.selectAll("g")
            .data(resourceStatObjs)
              .enter().append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(0," + i * 14 + ")"; });
  
          legend.append("rect")
            .attr("x", 0)
            .attr("width", 10)
            .attr("height", 10)
            .style("fill", function(d,i) { return d.color; });
  
          legend.append("text")
              .attr("x", 14)
              .attr("y", 5)
              .attr("dy", ".35em")              
              .attr("class", "statunselected")      
              .style("fill", function(d,i) { return ($scope.current_statistic == d.variable) ? d.color : "#bebebe"; })
              .text(function(d) { return d.name; })
              .on("click", function(d, i) { 
                  legend.selectAll(".statunselected").style("fill", "#bebebe");
                  d3.select(this).style("fill", function(d) { return d.color; });
                  $scope.selectStatistic(d.variable);
              })
              
      }
      */

      $scope.updateLevelsCompare = function(element, factor, stat) {
          var chartData = [];
          chartData.push(xaxis);
          var levelnames = d3.keys($scope.group_resource_stat_data_json[factor].levels);
          
          var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[stat].lightColor, varlookup[stat].darkColor]); 
          var buckets = d3.range(0, 1, 1/levelnames.length);
          buckets = buckets.map(function (input) { return color(input); });
          var colorScale = d3.scale.ordinal()
              .domain(levelnames)
              .range(buckets);
          
         var levellinecolors = [];
         var maxVal = [];
 
        levelnames.forEach(function(levelname, index) {
            //console.log("in levels");
            var tmp = [];
            tmp.push($scope.group_resource_stat_data_json[factor].levels[levelname].dname);
            tmp = tmp.concat($scope.group_resource_stat_data_json[factor].levels[levelname].stats[stat].slice(1));
            chartData.push(tmp);
            levellinecolors[$scope.group_resource_stat_data_json[factor].levels[levelname].dname] = colorScale(levelname);
            maxVal.push(d3.max(tmp.slice(1)));

          }); 
          console.log(chartData);   
          $scope.levelsCompareChart[element].load({ columns: chartData });
          $scope.levelsCompareChart[element].axis.max({y: d3.max(maxVal)});
          $scope.levelsCompareChart[element].axis.min({y: d3.min(0)});
          $scope.levelsCompareChart[element].data.colors(levellinecolors);
      };

      $scope.setupLevelsCompare = function(element, factor, stat) {
          
          //$scope.groupCompareChart = {};
          var chartData = [];
          chartData.push(xaxis);
          var levelnames = d3.keys($scope.group_resource_stat_data_json[factor].levels);
          
          // set up colors
          var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[stat].lightColor, varlookup[stat].darkColor]); 
          var buckets = d3.range(0, 1, 1/levelnames.length);
          buckets = buckets.map(function (input) { return color(input); });
          var colorScale = d3.scale.ordinal()
              .domain(levelnames)
              .range(buckets);
              
          var levellinecolors = [];
          var maxVal = [];
          
          levelnames.forEach(function(levelname, index) {
            //console.log("in levels");
            var tmp = [];
            tmp.push($scope.group_resource_stat_data_json[factor].levels[levelname].dname);
            tmp = tmp.concat($scope.group_resource_stat_data_json[factor].levels[levelname].stats[stat].slice(1));
            chartData.push(tmp);
            maxVal.push(d3.max(tmp.slice(1)));
            levellinecolors[$scope.group_resource_stat_data_json[factor].levels[levelname].dname] = colorScale(levelname);
          }); 
          console.log(chartData);    
          console.log(maxVal);                       
          
          $scope.levelsCompareChart[element] = c3.generate({
                bindto: element,
                size: {
                    height: 150,
                  }, 
                data: {
                    x: 'x',
                    columns: chartData,
                    type: 'line',
//                    names: varnames, 
                      colors: levellinecolors, 
                    //labels:false,
                  }, // data
                axis: {
                    x: {
                        //type: 'timeseries',
                        tick: {
                          count: 2,
                          //format: '%Y'
                        },  
                        padding: {
                            top: 0,
                            right: 0,
                            bottom: 0,
                            left: 0,
                        }
                      },
                    y: {
                        max: d3.max(maxVal),
                        min: 0,
                        padding: {
                            top: 0,
                            right: 0,
                            bottom: 0,
                            left: 0,
                        }
                     } 
                },  
                legend: {
                  position: 'right'
                },
               
            });  
            
          // now do the legend  
          var svg = d3.selectAll(element + "Legend").append("svg");          
          
      } 
      
      $scope.selectStatistic = function(stat) {
        console.log("selecting statistic:" + stat);
        $scope.current_statistic = stat;       
        $scope.$apply();        
      }
      $scope.selectCountry = function(country) {
        console.log("selecting country:" + country);
        $scope.current_country_id = country;
        $scope.current_group_id = null;
        $scope.current_selection = country;        
        $scope.$apply();        
      }
      $scope.selectGroup = function(group, value) {
        console.log("selecting group:" + group + " with value: " + value);
        $scope.current_country_id = null;
        $scope.current_group_id = {"factor": group, "level": value };
        $scope.current_selection = {"factor": group, "level": value };
       } // end ftn   
              
      $scope.selectOnMap = function(countries) {
        console.log("selecting countries");
        
        var svg = $scope.chart1.svg;
        
        for (countryObjKey in $scope.country_data_json) {
          svg
              .selectAll('.' + countryObjKey)
              .classed({'plainpaths':true,'grouppaths':false });  
        }
        countries.forEach(function(country, index) {
            svg
              .selectAll('.' + country)
              .classed({'plainpaths':false,'grouppaths':true });        
        });
      }
      
      
      // -------------------------------------------------------------------------      
      // Heatmap Object
      // -------------------------------------------------------------------------                

      // call it like this var a = new Heatmap("calc_govt_take", xaxis.slice(1, xaxis.length-1))
      // call it like this var a = new Heatmap("calc_govt_take", d3.range(2000,2012))
      

      Heatmap = function(element, rowlabels) {
        this.stat = null;
        this.rowlabels = rowlabels;        
        this.numrows = rowlabels.length;
        this.numcountries = null;
        this.countries = [];
        this.chartData = [];
        this.data = [];
        this.gridSize = null;
        
        this.element = element;
        this.colorScale = {};        
        this.svg = {};
        this.countryg = {};
        
        this.countries = d3.keys($scope.country_data_json).filter(function(ccode) { return $scope.country_data_json[ccode].haveResourceStats == "1";});          
        this.numcountries = this.countries.length;
        
        this.currentRowSelection = 0;
        
        this.margin = { top: 15, right: 0, bottom: 5, left: 50 };
        this.width = 1100 - this.margin.left - this.margin.right;
        this.height = 350 - this.margin.top - this.margin.bottom;
        this.gridSize = Math.floor(this.width / this.numcountries),
        this.legendElementWidth = this.gridSize*2;       
        this.padding = 2;
 
                  
        this.setupData = function(whichstat) {
          this.chartData = [];
          this.stat = whichstat;
          this.countries.forEach(function(ccode, index) {
            this.rowlabels.forEach(function(row, rindex) {
              var entry = new Object();
              entry.ccode = ccode;
              entry.row = rindex;     
              entry.name = $scope.country_data_json[ccode].name;
              entry.value = $scope.country_resource_stat_data_json[ccode][whichstat][rindex];
              this.chartData.push(entry);              
            }, this);  
          }, this);       
          //console.log("this.chartData");
          //console.log(this.chartData);
  
          this.sortData(this.currentRowSelection);
        };
      
      this.setupChart = function() {
              
        
        var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[this.stat].lightColor, varlookup[this.stat].darkColor]); 
        var colorq = d3.range(.1, 1.1, .1);
        colorq = colorq.map(function (input) { return color(input); });
        
        //console.log(colorq);
        this.colorScale = d3.scale.quantize()
              .domain([d3.min(this.chartData, function (d) { return d.value; }), d3.max(this.chartData, function (d) { return d.value; })])
              .range(colorq);
      };
      
      this.drawChart = function() {
        
        var chart = this;
        
        var localgridsize = this.gridSize;
        var padding = this.padding;
        var cs = this.colorScale;

        var container = d3.select(this.element).append("svg")
            .attr("width", this.width + this.margin.left + this.margin.right)
            .attr("height", this.height + this.margin.top + this.margin.bottom);
              
        var labels = container.append("g")
            .attr("transform", "translate(6," + (this.margin.top + 24) + ")")
            .selectAll("text")
            .data(this.rowlabels)
            .enter()
            .append("text")
            .text(function (d) { return d; })
            .attr("x", 0)
            .attr("id", function (d,i) { return i; })
            .attr("y", function(d,i) { return i*localgridsize})
            .attr("class", "heatrowlabel")    
            .style("fill", function (d,i) { return (chart.currentRowSelection == i) ? "#000000" : "#bebebe"; })
            //.attr("transform", "rotate(-90)")              
            .style("text-anchor", "start")
            .on("click", function(d, i) { 
              container.selectAll(".heatrowlabel").style("fill", "#bebebe");
              d3.select(this).style("fill", "#000000");
              chart.currentRowSelection = i;
              chart.updateChart(null,i);              
              });
            /*  
            .on("mouseover", function(d, i) { 
              //container.selectAll(".heatrowlabel").style("fill", "#bebebe");
              d3.select(this).style("fill", "#000000");
              //chart.currentRowSelection = i;
              //chart.updateChart(null,i);              
            })  
            .on("mouseout", function(d, i) { 
              //container.selectAll(".heatrowlabel").style("fill", "#bebebe");
              d3.select(this).style("fill", function (d,i) { return (chart.currentRowSelection == i) ? "#000000" : "#bebebe"; });
              //chart.currentRowSelection = i;
              //chart.updateChart(null,i);              
            });  
            */
        this.svg = container.append("g")
            .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");            
              
        this.countryg = this.svg.selectAll("g").data(this.data).enter()
            .append("g")
            .attr("transform",function(d,i) {return "translate(" + (localgridsize*(i)) + ",0)" });
        this.countryg
            .append("text")
              .text(function (d) { return d.key; })
              .attr("x", 0)
              .attr("y", 0)
              .attr("class", "heatcountrylabel")              
              .attr("transform", "rotate(-90)")              
              .style("text-anchor", "middle")
                .append("title")
                .text(function(d) {return d.values[0].name; });
        this.countryg
              .selectAll("rect")
              .data(function(d) {return d.values}) 
              .enter()
                  .append("rect")
                  .attr("x", -this.gridSize + 2*padding)
                  .attr("y", function(d,i) { return 10 + padding + (d.row * localgridsize); })
                  //.attr("class", "hour bordered")
                  .attr("width", function(d,i) { return localgridsize - padding; })
                  .attr("height", function(d,i) { return localgridsize - padding; })
                  .style("fill", function(d,i) { return (d.value == null) ? "#eee" : cs(d.value); })
                  // throwing in a title element
                  .append("title")
                    .text(function(d) {return (d.value == null) ? "null" : d3.round(d.value,2);});                   
      };
      
      this.sortData = function(whichrow) {
        var chart = this;
         this.data=d3.nest()
          .key(function(d) {return d.ccode;})
          .sortKeys(function(a,b) { return chart.doSort(a,b, whichrow); }) 
          .entries(this.chartData);
        //console.log("data");        
        //console.log(this.data);         
      };
      
      this.selectCountries = function(countries) {
        console.log("countries to highlight in heat");
        console.log(countries);
        
        var allcountrylabels = this.svg.selectAll("text.heatcountrylabel");
        allcountrylabels.style("fill", function(d,i) { return (countries.indexOf(d.key) != -1) ? "#000000" : "#bebebe" } );
      };
      
      this.updateChart = function(whichstat, whichrow) {
        var chart = this;
        var localgridSize = this.gridSize;
        this.currentRowSelection = (whichrow == null) ? this.currentRowSelection : whichrow;
        
        if (whichstat == null) {
          this.sortData(this.currentRowSelection);  

          var update = this.svg.selectAll("g").data(this.data, function(d) { return d.key; });
          //console.log(update);
          //update selection          
          update.transition()
            .duration(1000)
            .attr("transform",function(d,i) { return "translate(" + (localgridSize*(i)) + ",0)" });
          //clearInterval(myint);
        } else {
          this.setupData(whichstat);
          this.setupChart();
          this.sortData(this.currentRowSelection);
          
          var rects = this.svg.selectAll("g").data(this.data, function(d) { return d.key; })
            .selectAll("rect")
            .data(function(d) { return d.values}, function(d) { return d.row; })
                .style("fill", function(d,i) { return (d.value == null) ? "#eee" : chart.colorScale(d.value); });
      
          var titles = this.svg.selectAll("g").data(this.data, function(d) { return d.key; })
            .selectAll("title")
            .data(function(d) { return d.values}, function(d) { return d.row; })
                    .text(function(d) {return (d.value == null) ? "null" : d3.round(d.value,2) ;}, function(d) { return d.row; });                
          
          var update = this.svg.selectAll("g").data(this.data, function(d) { return d.key; });
          update.transition()
            .duration(1000)
            .attr("transform",function(d,i) { return "translate(" + (chart.gridSize*(i)) + ",0)" });
        }        
      }; // updateChart  
      
      this.doSort = function(a, b, whichrowindex) {

          var nestdata = this.chartData.filter(function (elem, index) { return elem.row == whichrowindex; });          
          var nestData2 = [];
          
          nestdata.forEach(function(elem, index) {
            nestData2[elem.ccode] = elem.value; 
          });

          //if (nestData2[a] == null && nestData2[b] == null) return 0;
          // both values are null then sort by alphabetical order
          if (nestData2[a] == null && nestData2[b] == null) {
            return (a > b) ? 1 : -1;
          }
                    
          if (nestData2[a] == null) return 1;
          if (nestData2[b] == null) return -1;
                    
          if (nestData2[a] > nestData2[b]) return -1;
          if (nestData2[a] < nestData2[b]) return 1;
          return 0;                          
      }; // doSort
      
      } // HEatmap


      // -------------------------------------------------------------------------      
      // Helper functions to manage user clicks.
      // -------------------------------------------------------------------------                

      function getTimeSeriesAverageByCountry(ccode, statname) {
        //console.log("getting avg" + statname);
        //console.log($scope.country_macro_stat_data_json[ccode]);
        if ($scope.country_macro_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_macro_stat_data_json[ccode][statname]);    
        }  
        else if ($scope.country_resource_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_resource_stat_data_json[ccode][statname]);                    
        }
        else 
          return null;            
      };              
      
      function getTimeSeriesAverage(statName) {
        var statData = {};
        for (countryObjKey in $scope.country_data_json) {
          statData[countryObjKey] = getTimeSeriesAverageByCountry(countryObjKey, statName);    
        }
        console.log(statData);
        return statData;
      };
              
      function getCountriesInGroup(data, group, value) {
        console.log("Getting countries in " + group + " that are " + value);
        var out = [];
        //console.log(d3.keys(data));
        var keys = d3.keys(data);
        
        keys.forEach(function(ccode, index) {
          //console.log(ccode);
          //console.log(data[ccode]);
          //console.log(data[ccode][group]);
          if(data[ccode][group] == value) out.push(ccode);
        });
        //console.log(out);
        return out;
      }
      
    }); // controller
    
    </script>
    
    <script>
    
      // ----------------------------------------------------------------------      
      // I would like to load this separately from a JSON file, but don't know
      // how to do two seperate JSON files.  For now I will put these
      // constants here.
      // ----------------------------------------------------------------------                
    
      console.log("loading lookup constants for variables");
      var varlookupvals = 
        [ {
           "variable": "calc_gov_resrev_gdp",
          "values": {
           "name": "Govt Resource Revenue",
          "source": "Calculated: avg of REV$rev_gov_resrev_gdp and REV2$rev2_gov_resrev_gdp",
          "color": "1f77b4",
          "order": 4
          } 
          },{
           "variable": "calc_govt_take",
          "values": {
           "name": "Government Take",
          "source": "Calculated: calc_gov_resrev_gdp / calc_rent_total_gdp",
          "color": "8c564b", //#a6a6a6 ff7878 8c564b,
          "order": 1
          } 
          },{
           "variable": "econ_gdpcon",
          "values": {
           "name": "GDP (constant $)",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_gdpconpc",
          "values": {
           "name": "GDP per capita (constant $)",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_govexp",
          "values": {
           "name": "Government Expenditure",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_govrev",
          "values": {
           "name": "Government Revenue",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_invtotal",
          "values": {
           "name": "Value of Investments",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_tax",
          "values": {
           "name": "Government Tax Revenue",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "calc_rent_total_gdp",
          "values": {
           "name": "Total Rents",
          "source": "Calculated from RENT: sum of RENT$rent_min, RENT$rent_oil, RENT$rent_gas",
          "color": "d62728",
          "order": 2
          } 
          },{
           "variable": "rev_gov_resrev_gdp",
          "values": {
           "name": "Government Resource Revenue",
          "source": "Resource_Revenue",
          "color": "" 
          } 
          },{
           "variable": "rev_gov_resrev_govtrev",
          "values": {
           "name": "Govt Resource Revenue(%GovtRev)",
          "source": "Resource_Revenue",
          "color": "2ca02c",
          "order": 6
          } 
          },{
           "variable": "rev2_gov_nonresrev_gdp",
          "values": {
           "name": "Govt Non-Resource Revenue",
          "source": "Resource_Revenue2",
          "color": "9467bd", //9467bd 1f77b4
          "order": 5
          } 
          },{
           "variable": "rev2_gov_resrev_gdp",
          "values": {
           "name": "Govt Resource Revenue",
          "source": "Resource_Revenue2",
          "color": "" 
          } 
          },{
           "variable": "rev2_gov_rev_gdp",
          "values": {
           "name": "Total Govt Revenue",
          "source": "Resource_Revenue2",
          "color": "bcbd22", //8c564b bcbd22
          "order": 3

           }
           }
         ];

        
        var varnames = {};
        var varcolors = {};
        var varlookup = {};

        //var c = d3.scale.category10();
        //var dataAvailable = c(0);
        var dataAvailable = "#ffbb78";
        varlookupvals.forEach(function(item, index) {
          //console.log(item);
          varnames[item.variable] = item.values.name;
          varcolors[item.variable] = "#".concat(item.values.color);
          varlookup[item.variable] = item.values;
          
          if (varcolors[item.variable] != "#") {            
            var baseColor = d3.rgb(varcolors[item.variable]);
            var darkest = baseColor.darker().darker().darker();
            var lightest = baseColor.brighter().brighter().brighter();
            //console.log(darkest.toString());
            //console.log(lightest.toString());
            
            varlookup[item.variable]["lightColor"] = lightest.toString();
            varlookup[item.variable]["darkColor"] = darkest.toString();
          }
        }); 
      
      // I tried to use the default from lighter() and darker() above
      // but didn't like the result, so just picked these instead.
      varlookup["calc_govt_take"].lightColor = "#dcccc9";
      varlookup["calc_govt_take"].darkColor = "#54332d";
      varlookup["calc_gov_resrev_gdp"].lightColor = "#bbd6e8";
      varlookup["calc_gov_resrev_gdp"].darkColor = "#12476c";
      varlookup["calc_rent_total_gdp"].lightColor = "#f2bebe";
      varlookup["calc_rent_total_gdp"].darkColor = "#951b1c";
      varlookup["rev2_gov_nonresrev_gdp"].lightColor = "#ded1eb";
      varlookup["rev2_gov_nonresrev_gdp"].darkColor = "#4a335e";
      varlookup["rev_gov_resrev_govtrev"].lightColor = "#bfe2bf";
      varlookup["rev_gov_resrev_govtrev"].darkColor = "#114011";
      varlookup["rev2_gov_rev_gdp"].lightColor = "#eaebbc";
      varlookup["rev2_gov_rev_gdp"].darkColor = "#5e5e11";
    
    
      console.log(varlookup);
        
        var lookupfactors = [
          {
            "factor": "class_income",
            "name": "Income",
            "color": "",
            "levels": [ 
              { "level": "Low income", "dname":"Low", "code": "LINC" },
              { "level": "Lower middle income", "dname":"Lower Middle", "code": "LMINC" },
              { "level": "Upper middle income", "dname":"Upper Middle", "code": "UMINC" },
              { "level": "High income", "dname":"High", "code": "HINC" },   
            ]
          },
          {
            "factor": "class_reg",
            "name": "Region",
            "color": "",
            "levels": [ 
              { "level": "Africa", "dname":"Africa", "code": "AFR" },
              { "level": "Asia", "dname":"Asia", "code": "ASIA" },
              { "level": "Europe", "dname":"Europe", "code": "EUR" },
              { "level": "Latin America and the Caribbean", "dname":"LAmer.&Carr.", "code": "LAMERC" },   
              { "level": "North America", "dname":"NAmerica", "code": "NAMER" },   
              { "level": "Oceania", "dname":"Oceania", "code": "OCA" },   
            ]
          },
          {
            "factor": "prim_rent",
            "name": "Main Rent Source",
            "color": "",
            "levels": [ 
              { "level": "Oil", "dname":"Oil", "code": "OIL" },
              { "level": "Gas", "dname":"Gas", "code": "GAS" },
              { "level": "Coal", "dname":"Coal", "code": "COAL" },   
              { "level": "Minerals", "dname":"Minerals", "code": "MIN" },
            ]
          },
          {
            "factor": "class_opec",
            "name": "OPEC",
            "color": "",
            "levels": [ 
              { "level": "OPEC", "dname":"Member", "code": "OPEC" },
              { "level": "Non-OPEC", "dname":"Non-Member", "code": "NOPEC" },
            ]
          },         
        ];
        
        console.log("lookupfactors");                
        console.log(lookupfactors);
        //console.log(c("calc_govt_take"));
        
      
    </script>

  </body>
</html>