<html lang="en" ng-app="eimodule" ng-init="current_country_id='RUS'">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UNDP Extractive Industries Data Dive</title>

    <!-- Load c3.css Style -->
    <link href="css/c3.css" rel="stylesheet" type="text/css">
    <link href="https://rawgit.com/masayuki0812/c3/master/c3.css" rel="stylesheet" type="text/css">
    
    

    <!-- Bootstrap Style -->
    <link href="css/bootstrap.min.css" rel="stylesheet">  
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Application Specific Styles -->  
    <link href="css/ei.css" rel="stylesheet">  
   
  </head>
  <body ng-controller="ei_countrySelect_control">

    <!-------------------------------------------------------------------------        
      Load Some Scripts We Need      
      ------------------------------------------------------------------------->

    <!-- For D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- For TopoJSON and DataMaps -->
    <script src='http://d3js.org/topojson.v1.min.js' type='text/javascript'></script>
    <script src='http://datamaps.github.io/scripts/datamaps.all.min.js' type='text/javascript'></script>
    <!-- Load c3.js -->
    <!-- <script src="js/c3.min.js"></script>  -->
    <script src="https://rawgit.com/masayuki0812/c3/master/c3.js"></script>
    
    
    
    <!--
    <script src="http://c3js.org/js/c3.min-631d1d50.js"></script>
    -->
    <!-- Load angular.js -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js' type='text/javascript'></script>
    <!-- ColorBrewer Colors -->
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Extractive Industries and Development</h1>
        <p>What is the relationship between extractive industry profitability and fiscal revenue from resources?</p>
      </div>
    </div>

    <!-------------------------------------------------------------------------        
      Define Page Layout
      
      This section uses bootstrap to create "cells" on the page for each visual-
      ization.  
      You can add rows, and columns within rows, at the end as needed 
      to accomodate more content.
      Within a cells, there may be a DIV that is a placeholder for a 
      visualization that is later generated by JavaScript
      ------------------------------------------------------------------------->
    
    <!-- Set up our Bootstrap Layout Grid -->
    <div class="container">
      <div class="row" style="padding-bottom:4px;">
            <div class="col-md-12 text-left mycol medtext">
              <h6 style="display:inline;padding-top:0px;margin-top:0px;margin-bottom:2px">Select</h6> 
              a country by clicking on the map, or  
              a group of countries by clicking its button.  Data presented for a group respresents the average values for a country in that group.                
              <h6 style="display:inline;padding-top:0px;margin-top:0px;margin-bottom:2px">Choose</h6>
              a statistic to color countries according to the average value of reported data for that statistic from 2000 to 2011.  
              Darker colors indicate higher average values.
              Government Take is Government Resource Revenue / Total Rents.
              All other statistics are given as %GDP, unless noted. 
              See below for sources and notes on calculations.<br>               
            </div>
      </div>  
      <div class="row">        
        <div class="col-md-8 text-left"> 
          <div class="row">
            <div class="col-md-12 text-left mycol">
                  <div class="datatext">              
                    Income
                     <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Low income')">Low</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Lower middle income')">Lower Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Upper middle income')">Upper Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'High income')">High</button>
                    </div>  
                  </div>
                  <div class="datatext">              
                      Region
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Africa')">Africa</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Asia')">Asia</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Europe')">Europe</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Latin America and the Caribbean')">LAmer&Carr</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'North America')">NAmerica</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Oceania')">Oceania</button>                        
                      </div>  
                  </div>
                  <div class="datatext">              
                      Rent
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Oil')">Oil</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Gas')">Gas</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Minerals')">Minerals</button>
                      </div>  
                  </div>                  
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 text-left mycol">
                <div id='chart1'  style="height: 320px;"></div>
            </div>
          </div>  
        </div>  <!-- end first column -->            
        
        <div class="col-md-4 mycol">
          <h4 class="text-center" ng-bind='current_selection_name'></h4>
          <div id='chart2'></div> 
          <div id='chart3'></div>           
        </div>
        
      </div> <!-- end big row -->

      <div class="row">
        <div class="col-md-12 text-left mycol medtext">
           <h5 style="display:inline;">Compare <span ng-bind='current_statistic_name'></span></h5> between countries.  
           The currently selected country or group of countries is highlighted.
           Click a year to sort countries by values for that year.
           Hover over a square to see actual values.
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-12 text-left mycol">
          <div id="heat2"></div>          
        </div>
      </div>


      <div class="row">
        <div class="col-md-12 text-left mycol medtext">
           <h5 style="display:inline;">Compare <span ng-bind='current_statistic_name'></span></h5> across groups of countries.  
           Yearly values are the average of all countries within the group reporting data for that year.  Click the group to add/remove its line.
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-4 text-center mycol">
          <div class="datatext">by Income</div>
          <div id="incomeCompare"></div>
        </div>
        <div class="col-md-4 text-center mycol">
          <div class="datatext">by Region</div>
          <div id="regionCompare"></div>
        </div>
        <div class="col-md-4 text-center mycol">
          <div class="datatext">by Primary Rent Source</div>
          <div id="rentCompare"></div>
        </div>            
      </div>
      <div class="row">
        <div class="col-md-4 text-left mycol">  
          <div id="pie"></div>
        </div>
        <div class="col-md-4 text-left mycol">  
          <div id="expChart"></div>
        </div>
        <div class="col-md-4 text-left mycol">  
          <div id="prodpie"></div>
        </div>
      </div>  
      <div class="row">
        <div class="col-md-12 text-left mycol">  
          <div id=datasources></div>
        </div>
      </div>  
    </div> <!-- end container -->

 
    <!-------------------------------------------------------------------------        
      End Page Layout   
      From here on it is all JavaScript.
      ------------------------------------------------------------------------->


    <!-------------------------------------------------------------------------        
      Load Some More Scripts We Need    
      Documentation says we can do this at this point to decrease 
      page loading time.
      ------------------------------------------------------------------------->
      
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- <script src="http://code.jquery.com/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>

    <script src="js/LayerPie.js" type='text/javascript'></script>

    <script> 
    $(function(){
      $("#datasources").load("datasources.html"); 
    });
    </script> 
    
    <script>
    
    // -------------------------------------------------------------------------   
    // -------------------------------------------------------------------------      
    // Angular JavaScript Setup
    //
    // Note: this is not the ideal or best way to combine Angular and D3.
    // Right now all UI code is in the Angular controller.
    // Best way would be to wrap the UI code for each chart into their own
    // separate Angular Directive.  The Controller would take care of loading
    // the data and managing the events - mainly, updating the scope data
    // variables that each Directive then uses.  All the UI code would be
    // hidden behind the Directive's interface.
    // Just learning Angular, so staring with this initial implementation for 
    // now, hope to change in the future.
    // -------------------------------------------------------------------------
    // -------------------------------------------------------------------------      
    
  
    // -------------------------------------------------------------------------      
    // Create the Angular App - this is the root.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    
    // -------------------------------------------------------------------------      
    // Create Factory using our App.
    // Factory just wraps data retrieval method in this case.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    eimod.factory("eifactory", function($http) {
      var factory = {};    
      
      factory.getRawData = function() {
        return $http.get('eidata.json');      
      };  
      
    return factory;      
    });

    // -------------------------------------------------------------------------      
    // Create Controller using our App.
    // Controller holds all the business logic.
    // Controller has access to a $scope variable where we can store state.
    // -------------------------------------------------------------------------   
    eimod.controller("ei_countrySelect_control", function($scope, eifactory) {
      
      console.log("Starting controller");
      
      // -------------------------------------------------------------------------      
      // Initialize variables that will hold our data.
      // These vars sit on the $scope variable so all angular functions have
      // access to them.
      // FYI country data has been split into three variables for ease of use
      // 1) non-time-series data
      // 2) macro time-series data
      // 3) resource-related time-series data
      // -------------------------------------------------------------------------      
  
      // raw form that data is read in from file
      $scope.raw_data = [];
      //$scope.country_names = [];      
      
      // associative array (ccode is key) of non-time series country data
      $scope.country_data_json = [];
      // associative array (ccode is key) of time series macroeconomic data
      $scope.country_macro_stat_data_json = [];
      // associative array (ccode is key) of time series resource-related data
      $scope.country_resource_stat_data_json = [];      
      // associative array (ccode is key) of time series resource-related data
      // where the time series data is in an array format, not a JS object one
      // this is the format the c3 charts expect
      // same data as "country_resource_stat_data_json"
      $scope.country_resource_stat_data_arr = [];      
      $scope.country_export_stat_data_json = [];
      $scope.country_prod_stat_data_json = [];
            
      $scope.group_resource_stat_data_json = {};
      $scope.group_resource_stat_data_arr = [];
      $scope.group_gov_take_stat_data_arr = [];
      $scope.group_gov_revenue_stat_data_arr = [];
                            
       
      
      // name of the currently selected country
      $scope.current_country_name = "";
      $scope.current_statistic_name = "";
      // object that holds the default fill information for each country on 
      // the map 
      $scope.dataMapFillKeys = {};
      
 
      // stores our map and chart visualization variables
      $scope.chart1 = null;      
      $scope.chart2 = null;
      $scope.levelsCompareChart = {};
      
      $scope.initDone = false;
      
      // array of years
      // this is necessary for the c3 charts
      var xaxis = ["x",2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011];
      
      // -------------------------------------------------------------------------      
      // This function is called when the JSON data has been loaded.
      // It does 2 things:
      // 1) Any needed data processing (before the page uses the dat).  Saves results
      //    in $scope variables declared above.
      // 2) Sets up & creates each chart, and saves the variable in $scope.
      // -------------------------------------------------------------------------            
       
      eifactory.getRawData().success(function(data) {
                  
          // save raw data
          $scope.raw_data = data;
          console.log("$scope.raw_data: ");
          console.log($scope.raw_data);
          
    
          // take data out of raw data and puts into associative arrays
          // where it is easier to access          
          $scope.raw_data.forEach(function(countryObj, index) {
            // have to do this because these are stored in the JSON as array of length 1
            // but we just want regular associative array
            d3.keys(countryObj.country).forEach(function(key, index) {
              countryObj.country[key] = countryObj.country[key][0];                
            });            
            $scope.country_data_json[countryObj.country.ccode] = countryObj.country;
            $scope.country_macro_stat_data_json[countryObj.country.ccode] = countryObj.macroStats;
            $scope.country_resource_stat_data_json[countryObj.country.ccode] = countryObj.resourceStats;
            $scope.country_export_stat_data_json[countryObj.country.ccode] = countryObj.exportStats;
            $scope.country_prod_stat_data_json[countryObj.country.ccode] = countryObj.prodStats;            
          });           
          console.log("$scope.country_data_json: ");
          console.log($scope.country_data_json);  
          console.log("$scope.country_macro_stat_data_json: ");
          console.log($scope.country_macro_stat_data_json);  
          console.log("$scope.country_resource_stat_data_json: ");
          console.log($scope.country_resource_stat_data_json);  
          console.log("$scope.country_export_stat_data_json: ");
          console.log($scope.country_export_stat_data_json);  
          console.log("$scope.country_prod_stat_data_json: ");
          console.log($scope.country_prod_stat_data_json);  

          // this put the same resource data into array format
          // this is only necessary because c3 chart expects time series
          // data to come in this format.
          $scope.country_gov_take_stat_data_arr = [];
          $scope.country_gov_revenue_stat_data_arr = [];          
          $scope.country_export_stat_data_arr = [];          
          var gov_take_stats = ["calc_govt_take", "calc_gov_resrev_gdp", "calc_rent_total_gdp"];
          var gov_revenue_stats = ["calc_gov_resrev_gdp", "rev2_gov_nonresrev_gdp", "rev2_gov_rev_gdp","prod_total"];          
          var export_stats = ["exp_fuels", "exp_sitc27", "exp_sitc28", "exp_sitc68", "exp_sitc667", "exp_sitc971", "exp_eishare"];          

          $scope.raw_data.forEach(function(countryObj, index) {
            $scope.country_gov_take_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_gov_take_stat_data_arr[countryObj.country.ccode].push(xaxis);
            $scope.country_gov_revenue_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_gov_revenue_stat_data_arr[countryObj.country.ccode].push(xaxis);
            $scope.country_export_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_export_stat_data_arr[countryObj.country.ccode].push(xaxis);
           
            gov_take_stats.forEach(function(statname, index) {
                //console.log(countryObj.resourceStats);
                //console.log("current stat:" + statname);
                var tmp=[];
                tmp.push(statname);
                $scope.country_gov_take_stat_data_arr[countryObj.country.ccode].push(tmp.concat(countryObj.resourceStats[statname]));              
            });
            gov_revenue_stats.forEach(function(statname, index) {
                var tmp=[];
                tmp.push(statname);
                $scope.country_gov_revenue_stat_data_arr[countryObj.country.ccode].push(tmp.concat(countryObj.resourceStats[statname]));              
            });                                 
            export_stats.forEach(function(statname, index) {
                var tmp=[];
                tmp.push(statname);
                $scope.country_export_stat_data_arr[countryObj.country.ccode].push(tmp.concat(countryObj.exportStats[statname]));              
            });                                 
          });
          
          console.log("GOV TAKE: $scope.country_gov_take_stat_data_arr: ");
          console.log($scope.country_gov_take_stat_data_arr);  
          console.log("GOV REV: $scope.country_gov_revenue_stat_data_arr: ");
          console.log($scope.country_gov_revenue_stat_data_arr);  
          console.log("EXPORT: $scope.country_export_stat_data_arr: ");
          console.log($scope.country_export_stat_data_arr);  
 
          $scope.raw_data.forEach(function(countryObj, index) {
                       
            //var statData = Object();
            $scope.country_resource_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(xaxis);
                                
            for (var statname in countryObj.resourceStats) {
              //console.log(countryObj.resourceStats);
              //console.log(statname);
              var tmp=[];
              tmp.push(statname);
              $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(tmp.concat(countryObj.resourceStats[statname]));              
            }

          });
          console.log("$scope.country_resource_stat_data_arr: ");
          console.log($scope.country_resource_stat_data_arr);  
           
          // this part calculates average data for GROUPS of countries we are interested in
          // and stores it in objects that can be passed to charts
          // putting this data in different objects is purely for convenience
          // to use with the charting library.
          
          var resourceStats = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          
          factor_lookup_data.forEach(function(currentFactor, index) {
              //console.log("in lookup loop");
              //console.log(currentFactor);
              
              // have to make a copy of currentFactor explicitly or Javascript will point to same ref
              $scope.group_resource_stat_data_json[currentFactor.factor] = new Object();
              $scope.group_resource_stat_data_json[currentFactor.factor]["factor"] = currentFactor.factor;
              $scope.group_resource_stat_data_json[currentFactor.factor]["name"] = currentFactor.name;
              $scope.group_resource_stat_data_json[currentFactor.factor]["color"] = currentFactor.color;              
              $scope.group_resource_stat_data_json[currentFactor.factor].levels = [];
              
              $scope.group_resource_stat_data_arr[currentFactor.factor] = []; 
              $scope.group_gov_take_stat_data_arr[currentFactor.factor] = [];
              $scope.group_gov_revenue_stat_data_arr[currentFactor.factor] = [];
              
              currentFactor.levels.forEach(function(currentLevel, index) {
                
                $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level] = currentLevel;
                $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level].stats = [];                
                
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level] = [];  
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(xaxis);  
                
                
                $scope.group_gov_take_stat_data_arr[currentFactor.factor][currentLevel.level] = [];  
                $scope.group_gov_take_stat_data_arr[currentFactor.factor][currentLevel.level].push(xaxis);  

                $scope.group_gov_revenue_stat_data_arr[currentFactor.factor][currentLevel.level] = [];  
                $scope.group_gov_revenue_stat_data_arr[currentFactor.factor][currentLevel.level].push(xaxis);  
                
                var countries = getCountriesInGroup($scope.country_data_json, currentFactor.factor, currentLevel.level); 
                
                resourceStats.forEach(function(currentStat, sindex) {
                  //console.log(currentFactor.factor + "," + currentLevel.level+ "," + currentStat);
                  var timeseries = [];
                  countries.forEach(function(currentCountry, iindex) {
                    timeseries.push($scope.country_resource_stat_data_json[currentCountry][currentStat])
                  });                          
                  var byyears = d3.transpose(timeseries);
                  var tmp=[];
                  var avg;
                  tmp.push(currentStat);
                  byyears.forEach(function(currentYear, index){
                    avg = d3.mean(currentYear)
                    tmp.push((typeof avg === 'undefined') ? null : avg);
                  });
                  //console.log(tmp);
                  $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level].stats[currentStat] = tmp;
                  $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(tmp);  
                  
                  if (gov_take_stats.indexOf(currentStat) != -1) $scope.group_gov_take_stat_data_arr[currentFactor.factor][currentLevel.level].push(tmp); 
                  if (gov_revenue_stats.indexOf(currentStat) != -1) $scope.group_gov_revenue_stat_data_arr[currentFactor.factor][currentLevel.level].push(tmp); 
                });
              });
              
          });
          
          console.log("$scope.group_resource_stat_data_json");
          console.log($scope.group_resource_stat_data_json);
          console.log("$scope.group_resource_stat_data_arr");
          console.log($scope.group_resource_stat_data_arr);
          console.log("$scope.group_gov_take_stat_data_arr");
          console.log($scope.group_gov_take_stat_data_arr);
          console.log("$scope.group_gov_revenue_stat_data_arr");
          console.log($scope.group_gov_revenue_stat_data_arr);
          
           
          // this creates the default fill keys for the map, based
          // on whether we have any resource data
          // this object will be passed to data map          
          for (countryObjKey in $scope.country_data_json) {
            $scope.dataMapFillKeys[countryObjKey] = {};
            if ($scope.country_data_json[countryObjKey].haveResourceStats == "1") {
              //console.log("has stats");
              $scope.dataMapFillKeys[countryObjKey].fillKey = "haveResourceStats";
            }  
            else   
              $scope.dataMapFillKeys[countryObjKey].fillKey = "defaultFill";  
          }
          console.log("$scope.dataMapFillKeys:");
          console.log($scope.dataMapFillKeys);
          
                    
          $scope.current_selection_name = $scope.country_data_json[$scope.current_country_id]["name"];

      // -------------------------------------------------------------------------      
      // Create the c3 line chart for resource data
      // -------------------------------------------------------------------------      

                
          $scope.chart2 = c3.generate({
              
                  bindto: '#chart2',      
                  
                  size: {
                    height: 150,
                  },   
                  data: {
                    x: 'x',
                    columns: $scope.country_gov_take_stat_data_arr[$scope.current_country_id],
                    axes: { rev_gov_resrev_govtrev : 'y',calc_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_rev_gdp : 'y', calc_rent_total_gdp : 'y', calc_govt_take: 'y2' },
                    type: 'line',
                    types: {
                        calc_govt_take: 'area-spline',
                    },
                    names: varnames, 
                    colors: varcolors, 
                    labels:false,
                  }, // data  
                  axis: {
                    y: {
                      max: 100,
                      min: 0,
                      padding: {top:0, bottom:0},
                      label: {
                        text: 'GDP',
                      },                      
                      tick: { format: function (d) { return d3.round(d,2) + "%"; } },
                      ticks: 5
                    },
                    y2: { max: 1.4, 
                          min: 0, 
                          padding: {top:0, bottom:.2},
                          show: true,
                          label: {
                            text: 'Government Take Ratio',
                            position: 'outer-middle'
                          },
                          tick: { format: d3.format(".1f") },
                          ticks: 5
                        },
                    x: { min: 2000, max: 2011,
                         padding: {left:.5, right:.5}
                    }
                
                  }, // axis
              
                 legend: {
                    show: false
                  },
                  
          });// c3.generate
 /*
 r: function (d) {
 +            return d.id === 'data2' ? 10 : 2.5;
 +          } 
 */
       // -------------------------------------------------------------------------      
      // Create the c3 line chart for resource data
      // -------------------------------------------------------------------------      

          $scope.chart3 = c3.generate({
              
                  bindto: '#chart3',      
                  
                  size: {
                    height: 150,
                  },   
                  data: {
                    x: 'x',
                    columns: $scope.country_gov_revenue_stat_data_arr[$scope.current_country_id],
                    axes: { rev_gov_resrev_govtrev : 'y',calc_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_rev_gdp : 'y', calc_rent_total_gdp : 'y', calc_govt_take: 'y2', prod_total : 'y2' },
                    type: 'bar',
                    types: {
                        prod_total: 'area',
                        rev2_gov_rev_gdp: 'line'
                    },
                    groups: [
                      ['calc_gov_resrev_gdp', 'rev2_gov_nonresrev_gdp']
                    ],
                    names: varnames, 
                    colors: varcolors, 
                  }, // data  
                  axis: {
                    y: {
                      max: 100,
                      min: 0,
                      padding: {top:0, bottom:5},
                      label: {
                        text: 'GDP',
                      },
                      tick: { format: function (d) { return d3.round(d,2) + "%"; } },
                      ticks: 5                      
                    },
                    x: { min: 2000, max: 2011,  
                        padding: {left:.5, right:.5}                    
                    },
                    y2: { min: 0, 
                          padding: {top:0, bottom: 0},
                          show: true,
                          label: {
                            text: 'Total Production',
                            position: 'outer-top'
                          },
                          tick: { format: d3.format(".2s") },
                          ticks: 5                          
                        },
                  }, // axis
              
                 legend: {
                    show: false
                  },                  
                  
          });// c3.generate
 
       // -------------------------------------------------------------------------      
      // Create the c3 line chart for export data
      // -------------------------------------------------------------------------      
        var expcolumns = ["exp_fuels", "exp_sitc27", "exp_sitc28", "exp_sitc68", "exp_sitc667", "exp_sitc971","exp_eishare"];
        var pastels = d3.scale.ordinal().domain(expcolumns).range(colorbrewer.Pastel1[6]);
        var expcolors = {};
        expcolumns.forEach(function(col) {
          expcolors[col] = pastels(col);
        });
        expcolors["exp_eishare"] = "black";
        
          $scope.expChart = c3.generate({
              
                  bindto: '#expChart',      

                  size: {
                    width: 300,
                    height: 200,                    
                  },   
                  data: {
                    x: 'x',
                    columns: $scope.country_export_stat_data_arr[$scope.current_country_id],
                    axes: { 
                        exp_fuels : 'y',
                        exp_sitc27 : 'y',
                        exp_sitc28 : 'y',
                        exp_sitc68 : 'y', 
                        exp_sitc667 : 'y', 
                        exp_sitc971: 'y',
                        exp_eishare: 'y2'
                    },
                    type: 'bar',
                    types: {
                        exp_eishare: 'line',
                    },    
                    groups: [
                      ["exp_fuels", "exp_sitc27", "exp_sitc28", "exp_sitc68", "exp_sitc667", "exp_sitc971"]
                    ],
                    names: varnames, 
                    colors: expcolors
                  }, // data  
                  bar: {
                      width: { ratio: 1.2 }
                  }, 
                  axis: {
                    y: {
                      padding: {top:0, bottom:5},
                      label: {
                        text: 'Current US$',
                      },
                      tick: { format: function (d) { return d3.format("$,")(d3.round(d,0)); } },
                      ticks: 7                      
                    },
                    x: { min: 2000, max: 2011,  
                        padding: {left:.5, right:.5}                    
                    },
                    y2: { min: 0, 
                          max: 100,
                          padding: {top:0, bottom: 0},
                          show: true,
                          label: {
                            text: 'EI% of Total Exports',
                            position: 'outer-top'
                          },
                          tick: { format: function (d) { return d3.round(d,2) + "%"; } },
                          ticks: 5                          
                        }, 
                  }, // axis
              
                 legend: {
                    show: false
                  },                  
                  
          });// c3.generate
 

   
      // -------------------------------------------------------------------------      
      // Create the data map
      // -------------------------------------------------------------------------      
          
          //console.log("p width " + $("#chart1").parent().width());
          
          $scope.chart1 = new Datamap({
              element: document.getElementById('chart1'),
              scope: "world",
              fills: {
                defaultFill: "#eee", //#eee
                haveResourceStats: "#bebebe", //#faa632 //a65628 ffbb78 a65628 //#a6a6a6 dataAvailable bebebe
              },
              data: $scope.dataMapFillKeys,              
              "done": function(datamap) {
                  console.log("Datamap finished rendering.");
                  //$scope.datamap = datamap;
                  //console.log($scope.datamap);
                  datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography, data) {
                    //console.log("in on click datamap");
                    $scope.selectCountry(geography.id);
                    //$scope.current_country_id = geography.id;
                    //$scope.$apply();
                  });
              }, // done
              geographyConfig: {
                highlightOnHover: true,
                highlightFillColor: '#ff7f0e',
                //highlightBorderColor: '#ff7f0e',
                //highlightBorderWidth: 5,
              },
              "setProjection":   function(element) {
              var projection = d3.geo.equirectangular()
                     .scale(125)
                     .center([42, -26])
                     .rotate([-10,0])
              
                       var path = d3.geo.path()
                         .projection(projection);
                       
                       return {path: path, projection: projection}; 
               },
         }); // chart1 
          
        $scope.chart1.addPlugin('legendPlugin', function( layer, data, options ) {
          var self = this;
          options = options || {};
          data = data || {};
          
          var className = 'mylegend';
          console.log("Adding legend plugin to datamap.");
          $scope.doLegend(this, layer);
  
        });
        $scope.chart1.addPlugin('groupSelectPlugin', function( layer, data, options ) {
          var self = this;
          options = options || {};
          data = data || {};
          
          var className = 'mylegend';
          console.log("Adding group select plugin to datamap.");
          $scope.doGroup(this, layer);
  
        });
        
        
        //console.log($scope.current_statistic);
        //$scope.updateGroupStat($scope.current_statistic);
        //$scope.selectStatistic($scope.current_statistic);
        $scope.current_statistic = "calc_govt_take";
        $scope.current_statistic_name = varnames[$scope.current_statistic];

        //console.log("adding legend plug in");
        $scope.chart1.legendPlugin();
          
        $scope.selectOnMap(new Array($scope.current_country_id));
        
      // -------------------------------------------------------------------------      
      // Set up other charts
      // -------------------------------------------------------------------------      
        
        //$scope.doLegend();
        
      // -------------------------------------------------------------------------      
      // Lien charts to compare levels of different factors
      // -------------------------------------------------------------------------      
        
        $scope.setupLevelsCompare("#incomeCompare", "class_income", $scope.current_statistic);        
        $scope.setupLevelsCompare("#regionCompare", "class_reg", $scope.current_statistic);
        $scope.setupLevelsCompare("#rentCompare", "prim_rent", $scope.current_statistic);
        
  
      // -------------------------------------------------------------------------      
      // Heatmap to compare countries
      // -------------------------------------------------------------------------      
        $scope.heatmap = new Heatmap("#heat2", xaxis.slice(1, xaxis.length));
        $scope.heatmap.setupData("calc_govt_take");
        $scope.heatmap.setupChart();
        $scope.heatmap.drawChart();
        $scope.heatmap.selectCountries(new Array($scope.current_country_id));

      // -------------------------------------------------------------------------      
      // Pie Chart for Exports
      // -------------------------------------------------------------------------  
        //$scope.exportTotals = $scope.getExportTotals();
        var expdata = $scope.setupExportData($scope.current_country_id);     
        $scope.lp = new LayerPie("#pie", expdata);
        
      // -------------------------------------------------------------------------      
      // Pie Chart for Production
      // -------------------------------------------------------------------------  
        var proddata = $scope.setupProdData($scope.current_country_id);     
        $scope.lp_prod = new LayerPie("#prodpie", proddata);        
        

        $scope.initDone = true;
          
      }).error(function(err){
          throw(err);                     
      }); // getData


      // -------------------------------------------------------------------------      
      // "Listener" function that is called whenever the current_country_id is
      // changed.  When selection is made in datamap, datamap changes this variable
      // This updates the line chart
      // Have to check for nulls here becuase it is called right at the beginning,
      // before data is loaded
      // -------------------------------------------------------------------------                

    $scope.$watch('current_statistic', function(newValue, oldValue) {
        console.log('WATCH current_statistic newValue: ');
        console.log(newValue);
        
        if (!$scope.initDone) return;
        $scope.current_statistic_name = varnames[newValue];
        
        if(newValue == "default") {
          if ($scope.chart1 != null) $scope.chart1.updateChoropleth($scope.dataMapFillKeys);
          //$scope.updateGroupStat(statName);
        }           
          else {
          //$scope.current_statistic = statName;
          
          //$scope.updateGroupStat(statName);
            
          var countryVals = {};
          countryVals = getTimeSeriesAverage(newValue);
          
          var vals = [];
          for(key in countryVals) {
            vals.push(countryVals[key]);
          }            
          
          var color = d3.scale.linear()
                       .domain([d3.min(vals),d3.max(vals)])
                       .range([varlookup[newValue].lightColor, varlookup[newValue].darkColor]); //faa632 #ffbb78 b28254
         
          var chloroVals = {};
          for(key in countryVals) {
            //console.log("Key" + key + " is = " + countryVals[key]);
            //console.log("color" + ": " + color(countryVals[key]));
            
            if (countryVals[key] == null) {
                chloroVals[key] = "#eee";
            }
            else
                chloroVals[key] = color(countryVals[key]);
          }
          if ($scope.chart1 != null) $scope.chart1.updateChoropleth(chloroVals);
        }
        if ($scope.heatmap != null) $scope.heatmap.updateChart(newValue, null);
        
        if ($scope.levelsCompareChart != null) {
          $scope.updateLevelsCompare("#incomeCompare", "class_income", newValue);
          $scope.updateLevelsCompare("#regionCompare", "class_reg", newValue);
          $scope.updateLevelsCompare("#rentCompare", "prim_rent", newValue);          
        }
                   
    }, true);

    $scope.$watch('current_selection', function(newValue, oldValue) {
        console.log('WATCH current_selection newValue:');
        console.log(newValue);

        if (!$scope.initDone) return;

        var countries;
        
        if ($scope.current_country_id == null) {
          countries = getCountriesInGroup($scope.country_data_json, newValue.factor, newValue.level);
          if ($scope.chart1 != null) {
            $scope.selectOnMap(countries);
          } 
          if ($scope.group_resource_stat_data_json != null) {
            $scope.current_selection_name = newValue.level;          
          }
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.group_gov_take_stat_data_arr[newValue.factor][newValue.level] })
          if ($scope.chart3 != null) {
          //console.log("about to load--");
          //console.log($scope.group_gov_revenue_stat_data_arr[newValue.factor][newValue.level]);
            $scope.chart3.load({ columns: $scope.group_gov_revenue_stat_data_arr[newValue.factor][newValue.level] });
          }
        } else {
          countries = new Array(newValue);
          if ($scope.chart1 != null) $scope.selectOnMap(countries);
        
          if ($scope.country_data_json[newValue] != null) {
            //console.log($scope.country_data_json[newValue]);
            $scope.current_selection_name = $scope.country_data_json[newValue]["name"];          
          }    
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.country_gov_take_stat_data_arr[newValue] });          
          if ($scope.chart3 != null) $scope.chart3.load({ columns: $scope.country_gov_revenue_stat_data_arr[newValue] });          
          if ($scope.lp != null) $scope.lp.update($scope.setupExportData(newValue));
          $scope.lp_prod.update($scope.setupProdData(newValue))
          $scope.expChart.load({ columns: $scope.country_export_stat_data_arr[newValue] });
        }
        
        if ($scope.heatmap != null) $scope.heatmap.selectCountries(countries);
        
    }, true); 
 

      // -------------------------------------------------------------------------      
      // These are Event functions that are called when the user clicks a button 
      // on the datamap to
      // highlight or fill by a different variable
      // -------------------------------------------------------------------------                


      $scope.getProdScales = function(low, high) {
        var prodstats = d3.keys($scope.country_prod_stat_data_json[$scope.current_country_id]);
        var cscales = {};
        prodstats.forEach(function(chunk, index) {
          var chunkData = d3.values($scope.country_prod_stat_data_json).map(function(countryObj) { return countryObj[chunk]; });
          //console.log("numcountries " + chunkData.length);
          //console.log("prod chunkData");          
          //console.log(chunkData);
          var chunkDataByYears = d3.transpose(chunkData).slice(low, high);
          //console.log("prod chunkDataByYears");          
          //console.log(chunkDataByYears);
          //console.log(colorbrewer.Greys[9]);
          //var yearlyChunkScales = chunkDataByYears.map(function(yearData) { return d3.scale.linear().domain(d3.extent(yearData)).range(["blue", "red"]); });
          var yearlyChunkScales = chunkDataByYears.map(function(yearData) { return d3.scale.quantile().domain(yearData).range(colorbrewer.Greys[5]); });
          //var yearlyChunkScales = chunkDataByYears.map(function(yearData) { 
          //    return (yearData.every(function(el) { el == null; })) ? d3.scale.ordinal().range("white") : d3.scale.quantile().domain(yearData).range(colorbrewer.Greys[5]) });
          //console.log("yearlyChunkScales");          
          //console.log(yearlyChunkScales);
          //yearlyChunkScales.forEach(function(scale) { console.log(scale(2000)); });
          
          //var yearlyChunkScales = chunkDataByYears.map(function(yearData) { return d3.sum(yearData); });
          //console.log("yearlyChunkSum");          
          //console.log(yearlyChunkSum);
          cscales[chunk] = yearlyChunkScales;
        });
        console.log("brewer sclaes");
        
        console.log(cscales);
        return(cscales);
      };  



      $scope.getExportTotals = function() {
        var exportPieChunks = ["exp_fuels", "exp_sitc27", "exp_sitc28", "exp_sitc68", "exp_sitc667", "exp_sitc971"];
        var totals = {};
        exportPieChunks.forEach(function(chunk, index) {
          var chunkData = d3.values($scope.country_export_stat_data_json).map(function(countryObj) { return countryObj[chunk]; });
          //console.log("chunkData");          
          //console.log(chunkData);
          var chunkDataByYears = d3.transpose(chunkData);
          //console.log("chunkDataByYears");          
          //console.log(chunkDataByYears);
          var yearlyChunkSum = chunkDataByYears.map(function(yearData) { return d3.sum(yearData); });
          //console.log("yearlyChunkSum");          
          //console.log(yearlyChunkSum);
          totals[chunk] = yearlyChunkSum;
        });
        return(totals);
      };  
      
      $scope.setupProdData = function(ccode) {
        
        var data = $scope.country_prod_stat_data_json[$scope.current_country_id];
        var keys = d3.keys(data); // these are the chunks
        var vals = d3.values(data); // this is the array of values for each chunk

        console.log(keys);
        console.log(vals);        
       
        // now each array is the data for one single year
        // each entry in that array corresponds to keys above
        var ringData = d3.transpose(vals);        
        
        ringData = ringData.slice(7,12);   
        if ($scope.prodScales == null) $scope.prodScales = $scope.getProdScales(7,12);
        
        var labels = ["2007","2008", "2009","2010","2011"];
        console.log("prod data by years");
        console.log(ringData);

        var outData = [];
        
        console.log("$scope.prodScales");
        console.log($scope.prodScales);
        
        ringData.forEach(function(ringEl, ringIndex) {
          keys.forEach(function(chunkEl, chunkIndex) {
            var tmp = {};
            tmp["ring"] = labels[ringIndex];
            tmp["chunk"] = keys[chunkIndex]; // or chunkEl
            tmp["value"] = ringData[ringIndex][chunkIndex];
            tmp["arcvalue"] = ringData[ringIndex][chunkIndex]; //starts the same
            tmp["color"] = (ringData[ringIndex][chunkIndex] != null) ? $scope.prodScales[chunkEl][ringIndex](ringData[ringIndex][chunkIndex]) : "#ffffff";  
            tmp["total"] = null;  
            tmp["dispvalue"] = (labels[ringIndex] + " " + keys[chunkIndex] + " " + d3.format(",")(d3.round(ringData[ringIndex][chunkIndex],1)));             
            outData.push(tmp);
          });        
        });        
        
        var outdata2 = d3.nest()
                    .key(function(d) { return d.ring; })
                    .entries(outData);
        
        console.log(outdata2);
        return(outdata2);        
      }

 
      $scope.setupExportData = function(ccode) {
        
        var labels = [ "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007","2008", "2009","2010","2011","2012"];
        var exportPieChunks = ["exp_fuels", "exp_sitc27", "exp_sitc28", "exp_sitc68", "exp_sitc667", "exp_sitc971"];

        if ($scope.exportTotals == null) $scope.exportTotals = $scope.getExportTotals();
        //  console.log("$scope.exportTotals");          
        //  console.log($scope.exportTotals);
          var totals = {};
          var cscales = {};
        /*  
        if ($scope.exportTotals == null) {
          exportPieChunks.forEach(function(chunk, index) {
            var chunkData = d3.values($scope.country_export_stat_data_json).map(function(countryObj) { return countryObj[chunk]; });
            //console.log("chunkData");          
            //console.log(chunkData);
            var chunkDataByYears = d3.transpose(chunkData);
            cscales[chunk] = chunkDataByYears.map(function(yearData) { d3.scale.quantile(yearData).range
            //console.log("chunkDataByYears");          
            //console.log(chunkDataByYears);
            var yearlyChunkSum = chunkDataByYears.map(function(yearData) { return d3.sum(yearData); });
            //console.log("yearlyChunkSum");          
            //console.log(yearlyChunkSum);
            totals[chunk] = yearlyChunkSum;
          });         
        }
        */


        var data = new Object();
        exportPieChunks.forEach(function(key, index) {
          data[key] = $scope.country_export_stat_data_json[ccode][key];       
        });
          console.log("small export obj");          
          console.log(data)
        
        //vals = d3.values($scope.country_export_stat_data_json[ccode]);        

        //var data = $scope.country_export_stat_data_json[ccode];
        //keys = d3.keys($scope.country_export_stat_data_json[ccode]);
        keys = d3.keys(data);
        vals = d3.values(data);
         var color = d3.scale.ordinal().domain(keys).range(colorbrewer.Pastel1[6]);
       console.log(keys);
        console.log(vals);        
        // now each array is the data for one single year
        // each entry in that array corresponds to keys above
        var ringData = d3.transpose(vals);
        console.log("export data by years");
        console.log(ringData);
        
        var outData = [];
        
        ringData.forEach(function(ringEl, ringIndex) {
          keys.forEach(function(chunkEl, chunkIndex) {
            var tmp = {};
            tmp["ring"] = labels[ringIndex];
            tmp["chunk"] = keys[chunkIndex]; // or chunkEl
            tmp["value"] = ringData[ringIndex][chunkIndex];
            tmp["arcvalue"] = ringData[ringIndex][chunkIndex]; //starts the same
            tmp["color"] = color(chunkEl);  
            tmp["total"] = $scope.exportTotals[chunkEl][ringIndex];  
            tmp["dispvalue"] = (labels[ringIndex] + " " + varnames[keys[chunkIndex]] + " " + d3.format("$,")(d3.round(ringData[ringIndex][chunkIndex],0)));             
            outData.push(tmp);
          });        
        });        
        
        var outdata2 = d3.nest()
                    .key(function(d) { return d.ring; })
                    .entries(outData);
        
        console.log(outdata2);
        return(outdata2);        
      }

      $scope.doLegend = function(map, layer) {
        
          //console.log("in do legend2");
        
          var resourceStatNames = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          var resourceStatObjs = [];  
          
          resourceStatNames.forEach(function(stat, index) {
            var statObj = {};
            statObj.variable = stat;
            statObj.name = varnames[stat];
            statObj.color = varcolors[stat]; 
            statObj.selected = false;
            statObj.order = varlookup[stat].order;
            resourceStatObjs.push(statObj);
          });
          resourceStatObjs.sort(function(a, b) { return d3.ascending(a.order, b.order); });          
          var labelStartCoodinates = map.projection([-168, 12]);
          layer.attr("transform", function(d, i) { return "translate(" + labelStartCoodinates[0] + "," + labelStartCoodinates[1] + ")" });  

          var legend = layer.selectAll("g")
            .data(resourceStatObjs)
              //.sort(function(a,b) {  console.log("this is a: " + a.order); return d3.descending(a.order, b.order); })
              .enter()
              .append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(0," + i * 14 + ")"; });
  
          legend.append("rect")
            .attr("x", 0)
            .attr("width", 10)
            .attr("height", 10)
            .style("fill", function(d,i) { return d.color; });
  
          legend.append("text")
              .attr("x", 14)
              .attr("y", 5)
              .attr("dy", ".35em")              
              .attr("class", "statunselected")      
              .style("fill", function(d,i) { return ($scope.current_statistic == d.variable) ? d.color : "#bebebe"; })
              .text(function(d) { return d.name; })
              .on("click", function(d, i) { 
                  legend.selectAll(".statunselected").style("fill", "#bebebe");
                  d3.select(this).style("fill", function(d) { return d.color; });
                  $scope.selectStatistic(d.variable);
              })
      }


      $scope.updateLevelsCompare = function(element, factor, stat) {
          var chartData = [];
          chartData.push(xaxis);
          var levelnames = d3.keys($scope.group_resource_stat_data_json[factor].levels);
          
          var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[stat].lightColor, varlookup[stat].darkColor]); 
          var buckets = d3.range(0, 1, 1/levelnames.length);
          buckets = buckets.map(function (input) { return color(input); });
          var colorScale = d3.scale.ordinal()
              .domain(levelnames)
              .range(buckets);
          
         var levellinecolors = [];
         var maxVal = [];
 
        levelnames.forEach(function(levelname, index) {
            //console.log("in levels");
            var tmp = [];
            tmp.push($scope.group_resource_stat_data_json[factor].levels[levelname].dname);
            tmp = tmp.concat($scope.group_resource_stat_data_json[factor].levels[levelname].stats[stat].slice(1));
            chartData.push(tmp);
            levellinecolors[$scope.group_resource_stat_data_json[factor].levels[levelname].dname] = colorScale(levelname);
            maxVal.push(d3.max(tmp.slice(1)));

          }); 
          //console.log(chartData);   
          $scope.levelsCompareChart[element].load({ columns: chartData });
          $scope.levelsCompareChart[element].axis.max({y: d3.max(maxVal)});
          $scope.levelsCompareChart[element].axis.min({y: d3.min(0)});
          $scope.levelsCompareChart[element].data.colors(levellinecolors);
      };

      $scope.setupLevelsCompare = function(element, factor, stat) {
          
          //$scope.groupCompareChart = {};
          var chartData = [];
          chartData.push(xaxis);
          var levelnames = d3.keys($scope.group_resource_stat_data_json[factor].levels);
          
          // set up colors
          var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[stat].lightColor, varlookup[stat].darkColor]); 
          var buckets = d3.range(0, 1, 1/levelnames.length);
          buckets = buckets.map(function (input) { return color(input); });
          var colorScale = d3.scale.ordinal()
              .domain(levelnames)
              .range(buckets);
              
          var levellinecolors = [];
          var maxVal = [];
          
          levelnames.forEach(function(levelname, index) {
            //console.log("in levels");
            var tmp = [];
            tmp.push($scope.group_resource_stat_data_json[factor].levels[levelname].dname);
            tmp = tmp.concat($scope.group_resource_stat_data_json[factor].levels[levelname].stats[stat].slice(1));
            chartData.push(tmp);
            maxVal.push(d3.max(tmp.slice(1)));
            levellinecolors[$scope.group_resource_stat_data_json[factor].levels[levelname].dname] = colorScale(levelname);
          }); 
          //console.log(chartData);    
          //console.log(maxVal);                       
          
          $scope.levelsCompareChart[element] = c3.generate({
                bindto: element,
                size: {
                    height: 150,
                  }, 
                data: {
                    x: 'x',
                    columns: chartData,
                    type: 'line',
//                    names: varnames, 
                      colors: levellinecolors, 
                    //labels:false,
                  }, // data
                axis: {
                    x: {
                        //type: 'timeseries',
                        tick: {
                          count: 2,
                          //format: '%Y'
                        },  
                        padding: {
                            top: 0,
                            right: 0,
                            bottom: 0,
                            left: 0,
                        }
                      },
                    y: {
                        max: d3.max(maxVal),
                        min: 0,
                        padding: {
                            top: 0,
                            right: 0,
                            bottom: 0,
                            left: 0,
                        },
                        ticks: 6
                        //tick: { format: function(d) { console.log("stat to format" + stat); return (stat=="calc_govt_take") ? d3.round(d,1) : d3.round(d,2) + "%" } },                        
                     } 
                },  
                legend: {
                  position: 'right'
                },
               
            });  
            
          // now do the legend  
          var svg = d3.selectAll(element + "Legend").append("svg");          
          
      } 
      
      $scope.selectStatistic = function(stat) {
        console.log("SELECT statistic:" + stat);
        $scope.current_statistic = stat;       
        $scope.$apply();        
      }
      $scope.selectCountry = function(country) {
        console.log("SELECT country:" + country);
        $scope.current_country_id = country;
        $scope.current_group_id = null;
        $scope.current_selection = country;        
        $scope.$apply();        
      }
      $scope.selectGroup = function(group, value) {
        console.log("SELECT group:" + group + " with value: " + value);
        $scope.current_country_id = null;
        $scope.current_group_id = {"factor": group, "level": value };
        $scope.current_selection = {"factor": group, "level": value };
       } // end ftn   
              
      $scope.selectOnMap = function(countries) {
        //console.log("selecting countries");
        console.log("Select on map: " + countries);        
        
        var svg = $scope.chart1.svg;
        
        for (countryObjKey in $scope.country_data_json) {
          svg
              .selectAll('.' + countryObjKey)
              .classed({'plainpaths':true,'grouppaths':false });  
        }
        countries.forEach(function(country, index) {
            svg
              .selectAll('.' + country)
              .classed({'plainpaths':false,'grouppaths':true });        
        });
      }
      
      
      // -------------------------------------------------------------------------      
      // Heatmap Object
      // -------------------------------------------------------------------------                

      // call it like this var a = new Heatmap("calc_govt_take", xaxis.slice(1, xaxis.length-1))
      // call it like this var a = new Heatmap("calc_govt_take", d3.range(2000,2012))
      

      Heatmap = function(element, rowlabels) {
        this.stat = null;
        this.rowlabels = rowlabels;        
        this.numrows = rowlabels.length;
        this.numcountries = null;
        this.countries = [];
        this.chartData = [];
        this.data = [];
        this.gridSize = null;
        
        this.element = element;
        this.colorScale = {};        
        this.svg = {};
        this.countryg = {};
        
        this.countries = d3.keys($scope.country_data_json).filter(function(ccode) { return $scope.country_data_json[ccode].haveResourceStats == "1";});          
        this.numcountries = this.countries.length;
        
        this.currentRowSelection = 0;
        
        this.margin = { top: 15, right: 0, bottom: 5, left: 50 };
        this.width = 1100 - this.margin.left - this.margin.right;
        this.gridSize = Math.floor(this.width / this.numcountries),
        this.legendElementWidth = this.gridSize*2;       
        this.padding = 2;
        //this.height = 350 - this.margin.top - this.margin.bottom;
        this.height = this.numrows * (this.gridSize + this.padding); 
                  
        this.setupData = function(whichstat) {
          this.chartData = [];
          this.stat = whichstat;
          this.countries.forEach(function(ccode, index) {
            this.rowlabels.forEach(function(row, rindex) {
              var entry = new Object();
              entry.ccode = ccode;
              entry.row = rindex;     
              entry.name = $scope.country_data_json[ccode].name;
              entry.value = $scope.country_resource_stat_data_json[ccode][whichstat][rindex];
              this.chartData.push(entry);              
            }, this);  
          }, this);       
          //console.log("this.chartData");
          //console.log(this.chartData);
  
          this.sortData(this.currentRowSelection);
        };
      
      this.setupChart = function() {
              
        
        var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[this.stat].lightColor, varlookup[this.stat].darkColor]); 
        var colorq = d3.range(.1, 1.1, .1);
        colorq = colorq.map(function (input) { return color(input); });
        
        //console.log(colorq);
        this.colorScale = d3.scale.quantize()
              .domain([d3.min(this.chartData, function (d) { return d.value; }), d3.max(this.chartData, function (d) { return d.value; })])
              .range(colorq);
      };
      
      this.drawChart = function() {
        
        var chart = this;
        
        var localgridsize = this.gridSize;
        var padding = this.padding;
        var cs = this.colorScale;

        var container = d3.select(this.element).append("svg")
            .attr("width", this.width + this.margin.left + this.margin.right)
            .attr("height", this.height + this.margin.top + this.margin.bottom);
              
        var labels = container.append("g")
            .attr("transform", "translate(6," + (this.margin.top + 24) + ")")
            .selectAll("text")
            .data(this.rowlabels)
            .enter()
            .append("text")
            .text(function (d) { return d; })
            .attr("x", 0)
            .attr("id", function (d,i) { return i; })
            .attr("y", function(d,i) { return i*localgridsize})
            .attr("class", "heatrowlabel")    
            .style("fill", function (d,i) { return (chart.currentRowSelection == i) ? "#000000" : "#bebebe"; })
            //.attr("transform", "rotate(-90)")              
            .style("text-anchor", "start")
            .on("click", function(d, i) { 
              container.selectAll(".heatrowlabel").style("fill", "#bebebe");
              d3.select(this).style("fill", "#000000");
              chart.currentRowSelection = i;
              chart.updateChart(null,i);              
              });
              
        this.svg = container.append("g")
            .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");            
              
        this.countryg = this.svg.selectAll("g").data(this.data).enter()
            .append("g")
            .attr("transform",function(d,i) {return "translate(" + (localgridsize*(i)) + ",0)" });
        this.countryg
            .append("text")
              .text(function (d) { return d.key; })
              .attr("x", 0)
              .attr("y", 0)
              .attr("class", "heatcountrylabel")              
              .attr("transform", "rotate(-90)")              
              .style("text-anchor", "middle")
              .on("click", function(d, i) { 
                //console.log(d);
                $scope.selectCountry(d.key);
              })
                .append("title")
                .text(function(d) {return d.values[0].name; });
        this.countryg
              .selectAll("rect")
              .data(function(d) {return d.values}) 
              .enter()
                  .append("rect")
                  .attr("x", -this.gridSize + 2*padding)
                  .attr("y", function(d,i) { return 10 + padding + (d.row * localgridsize); })
                  //.attr("class", "hour bordered")
                  .attr("width", function(d,i) { return localgridsize - padding; })
                  .attr("height", function(d,i) { return localgridsize - padding; })
                  .style("fill", function(d,i) { return (d.value == null) ? "#eee" : cs(d.value); })
                  // throwing in a title element
                  .append("title")
                    .text(function(d) {return (d.value == null) ? "null" : d3.round(d.value,2);});                   
      };
      
      this.sortData = function(whichrow) {
        var chart = this;
         this.data=d3.nest()
          .key(function(d) {return d.ccode;})
          .sortKeys(function(a,b) { return chart.doSort(a,b, whichrow); }) 
          .entries(this.chartData);
        //console.log("data");        
        //console.log(this.data);         
      };
      
      this.selectCountries = function(countries) {
        console.log("Select countries in heatmap: ");
        console.log(countries);
        
        var allcountrylabels = this.svg.selectAll("text.heatcountrylabel");
        allcountrylabels.style("fill", function(d,i) { return (countries.indexOf(d.key) != -1) ? "#000000" : "#bebebe" } );
      };
      
      this.updateChart = function(whichstat, whichrow) {
        var chart = this;
        var localgridSize = this.gridSize;
        this.currentRowSelection = (whichrow == null) ? this.currentRowSelection : whichrow;
        
        if (whichstat == null) {
          this.sortData(this.currentRowSelection);  

          var update = this.svg.selectAll("g").data(this.data, function(d) { return d.key; });
          //console.log(update);
          //update selection          
          update.transition()
            .duration(1000)
            .attr("transform",function(d,i) { return "translate(" + (localgridSize*(i)) + ",0)" });
          //clearInterval(myint);
        } else {
          this.setupData(whichstat);
          this.setupChart();
          this.sortData(this.currentRowSelection);
          
          var rects = this.svg.selectAll("g").data(this.data, function(d) { return d.key; })
            .selectAll("rect")
            .data(function(d) { return d.values}, function(d) { return d.row; })
                .style("fill", function(d,i) { return (d.value == null) ? "#eee" : chart.colorScale(d.value); });
      
          var titles = this.svg.selectAll("g").data(this.data, function(d) { return d.key; })
            .selectAll("title")
            .data(function(d) { return d.values}, function(d) { return d.row; })
                    .text(function(d) {return (d.value == null) ? "null" : d3.round(d.value,2) ;}, function(d) { return d.row; });                
          
          var update = this.svg.selectAll("g").data(this.data, function(d) { return d.key; });
          update.transition()
            .duration(1000)
            .attr("transform",function(d,i) { return "translate(" + (chart.gridSize*(i)) + ",0)" });
        }        
      }; // updateChart  
      
      this.doSort = function(a, b, whichrowindex) {

          var nestdata = this.chartData.filter(function (elem, index) { return elem.row == whichrowindex; });          
          var nestData2 = [];
          
          nestdata.forEach(function(elem, index) {
            nestData2[elem.ccode] = elem.value; 
          });

          //if (nestData2[a] == null && nestData2[b] == null) return 0;
          // both values are null then sort by alphabetical order
          if (nestData2[a] == null && nestData2[b] == null) {
            return (a > b) ? 1 : -1;
          }
                    
          if (nestData2[a] == null) return 1;
          if (nestData2[b] == null) return -1;
                    
          if (nestData2[a] > nestData2[b]) return -1;
          if (nestData2[a] < nestData2[b]) return 1;
          return 0;                          
      }; // doSort
      
      } // HEatmap


      // -------------------------------------------------------------------------      
      // Helper functions to manage user clicks.
      // -------------------------------------------------------------------------                

      function getTimeSeriesAverageByCountry(ccode, statname) {
        //console.log("getting avg" + statname);
        //console.log($scope.country_macro_stat_data_json[ccode]);
        if ($scope.country_macro_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_macro_stat_data_json[ccode][statname]);    
        }  
        else if ($scope.country_resource_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_resource_stat_data_json[ccode][statname]);                    
        }
        else 
          return null;            
      };              
      
      function getTimeSeriesAverage(statName) {
        var statData = {};
        for (countryObjKey in $scope.country_data_json) {
          statData[countryObjKey] = getTimeSeriesAverageByCountry(countryObjKey, statName);    
        }
        //console.log(statData);
        return statData;
      };
              
      function getCountriesInGroup(data, group, value) {
        console.log("Getting countries in " + group + " that are " + value);
        var out = [];
        //console.log(d3.keys(data));
        var keys = d3.keys(data);
        
        keys.forEach(function(ccode, index) {
          //console.log(ccode);
          //console.log(data[ccode]);
          //console.log(data[ccode][group]);
          if(data[ccode][group] == value) out.push(ccode);
        });
        //console.log(out);
        return out;
      }
      
    }); // controller
    
    </script>
    
    <!-- This file contains the hard-coded lookup data for variables, factors-->
    <script src='js/eilookups.js' type='text/javascript'></script>
    
  </body>
</html>