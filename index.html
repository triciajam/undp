<html lang="en" ng-app="eimodule" ng-init="current_country_id='AGO'">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UNDP Extractive Industries Data Dive</title>

    <!-- Load c3.css Style -->
    <link href="css/c3.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap Style -->
    <link href="css/bootstrap.min.css" rel="stylesheet">  
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    
    <style>
    
    /*-------------------------------------------------------------------------        
      These override Bootstrap Styles
      -----------------------------------------------------------------------*/  

        .mybtn {
          margin-bottom: 5;
          margin-left: 5;
          margin-right: 5;
          background-color: #eee !important;
          border: 2px !important;
          border-color: #eee !important;
          border-style: solid !important;          
        }
        
        .mygroupselect {
          /* border: 1px solid #ccc; padding-left: 4px; padding-right: 4px; padding-top: 4px; */
          padding-left: 4px; padding-right: 4px; padding-top: 4px;      
        }
        
        h2 {
           margin-top:5px; margin-bottom:5px;
        }
        h3 {
           margin-top:5px; margin-bottom:5px;
        }
        h5 {
           margin-top:5px; margin-bottom:2px;
        }
        .jumbotron {
          padding-top: 0;
          padding-bottom: 0;
          margin-bottom: 10;
          
        }
        h1 {
          font-size: 50px !important;
        }
        
        .smalltext {
          font-size: 10px !important;
        }  
        .btnsmalltext {
          font-family: Consolas, courier !important;
          font-size: 9px !important;
        }
        
        .legend {
          
        }
    /*-------------------------------------------------------------------------        
      These are used for highlighting countries. bf8c5a bb7c25
      -----------------------------------------------------------------------*/  

        .grouppaths {
          stroke: #5f5f5f !important; /*bf8c5a 2f2f2f 5f5f5f */ 
          stroke-width: 1.8 !important;
          stroke-opacity: 1 !important;  
        }

        .plainpaths {
          stroke: #ffffff !important;
          stroke-width: 1.8 !important;
          stroke-opacity: .1 !important;
        }
        
    /*-------------------------------------------------------------------------        
      These override c3 Styles
      -----------------------------------------------------------------------*/  
      
        #chart2 .c3-line-econ_gdpcon {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_gdpconpc {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_tax {
          stroke-width: 0px;
        }
        #chart2 .c3-line-rev_gov_resrev_govtrev {
          stroke-width: 4px;
          stroke-dasharray: 5,5;
        }
        #chart2 .c3-line-rev_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_nonresrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_rev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_rent_total_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_govt_take {
          stroke-width: 0px;
        } 

        .c3-axis-y path {
          stroke-width: 0px !important;
        }
        .c3-axis-y2 path {
          stroke-width: 0px !important;
        }
        /*
        .c3-axis-y line {
          stroke-width: 0px !important;
        }
        */
        #incomeCompare .c3-circle {
          fill: none !important;
        }
    /*-------------------------------------------------------------------------        
      Group Comparison Small Multiples
      -----------------------------------------------------------------------*/  
        
        div[id*='smallmult'] .line {
          fill: none;
          /*stroke: #666;*/
          stroke-width: 1.5px;
        }
        div[id*='smallmult'] .area {
          /*fill: #e7e7e7;*/
        }
        /*
        div[id*='stat-'] {
          fill: none;
          stroke-width: 1.5px;
        }
        */
        .statunselected {
          text-anchor: start;
          font-size: 11;
          fill: #bebebe;          
        }
        .heatcountrylabel {
          text-anchor: start;
          font-family: Consolas, courier;
          font-size: 11;
          fill: #bebebe;          
        }
        /*#stat:hover { fill: "red" !important; };*/
        
    </style>

   
  </head>
  <body ng-controller="ei_countrySelect_control">

    <!-------------------------------------------------------------------------        
      Load Some Scripts We Need      
      ------------------------------------------------------------------------->

    <!-- For D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- For TopoJSON and DataMaps -->
    <script src='http://d3js.org/topojson.v1.min.js' type='text/javascript'></script>
    <script src='http://datamaps.github.io/scripts/datamaps.all.min.js' type='text/javascript'></script>
    <!-- Load c3.js -->
    <script src="js/c3.min.js"></script>
    
    <!--
    <script src="http://c3js.org/js/c3.min-631d1d50.js"></script>
    -->
    <!-- Load angular.js -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js' type='text/javascript'></script>
    <!-- ColorBrewer Colors -->
    <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Extractive Industries and Development</h1>
        <p>What is the relationship between extractive industry profitability and fiscal revenue from resources?</p>
      </div>
    </div>

    <!-------------------------------------------------------------------------        
      Define Page Layout
      
      This section uses bootstrap to create "cells" on the page for each visual-
      ization.  
      You can add rows, and columns within rows, at the end as needed 
      to accomodate more content.
      Within a cells, there may be a DIV that is a placeholder for a 
      visualization that is later generated by JavaScript
      ------------------------------------------------------------------------->
    
    <!-- Set up our Bootstrap Layout Grid -->
    <div class="container">
    
      <div class="row">
        
        <div class="col-md-8 text-left"> 
        
          <div class="row">
            <div class="col-md-12 text-left">
                <div id='chart1'  style="width: 700px;height: 300px;"></div>
            </div>
          </div>   
          
          <div class="row">
            <div class="col-md-12 text-left">                 
             Click a country on the map to select it and view its data. Click a button to select a country group and view its data. Click on the legend to fill the map by the statistic.
            </div>
          </div>  
          
          <div class="row">
            <div class="col-md-6 text-left mygroupselect">                 
                  <div class="smalltext" >              
                    Income
                     <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Low income')">Low</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Lower middle income')">Lower Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'Upper middle income')">Upper Middle</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_income', 'High income')">High</button>
                    </div>  
                  </div>
                  <div class="smalltext">              
                      Primary Rents
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Oil')">Oil</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Gas')">Gas</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Minerals')">Minerals</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('prim_rent', 'Coal')">Coal</button>
                      </div>  
                  </div>
                  <div class="smalltext">              
                      Region
                      <div class="btn-group btn-group-xs">
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Africa')">Africa</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Asia')">Asia</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Europe')">Europe</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Latin America and the Caribbean')">LAmer&Carr</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'North America')">North America</button>
                        <button class="btn btn-mini mybtn btnsmalltext" ng-click="selectGroup('class_reg', 'Oceania')">Oceania</button>                        
                      </div>  
                  </div>
            </div> <!-- 6 -->
            <div class="col-md-6 text-left">
              <div id="legend"></div>
            </div> <!-- 6 -->
          </div>  <!-- third row -->

          <div class="row">
            <div class="col-md-4 text-left">
              <div id="incomeCompare"></div>
            </div>
            <div class="col-md-4 text-left">
              <div id="regionCompare"></div>
            </div>
            <div class="col-md-4 text-left">
              <div id="rentCompare"></div>
            </div>            
          </div>
          
        </div>  <!-- end first column -->            
        
        <div class="col-md-4 text-left">
          <h3 ng-bind='current_selection_name'></h3>
          <div id='chart2'></div> 
        </div>
        
      </div> <!-- end big row -->
      <div class="row">
        <div class="col-md-12 text-left">
          <div id="heatyear"></div>          
        </div>
        <div class="col-md-12 text-left">
          <div id="heat2"></div>          
        </div>
      </div>
    </div> <!-- end container -->

 
    <!-------------------------------------------------------------------------        
      End Page Layout   
      From here on it is all JavaScript.
      ------------------------------------------------------------------------->


    <!-------------------------------------------------------------------------        
      Load Some More Scripts We Need    
      Documentation says we can do this at this point to decrease 
      page loading time.
      ------------------------------------------------------------------------->
      
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- <script src="http://code.jquery.com/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    
    <script>
    
    // -------------------------------------------------------------------------   
    // -------------------------------------------------------------------------      
    // Angular JavaScript Setup
    //
    // Note: this is not the ideal or best way to combine Angular and D3.
    // Right now all UI code is in the Angular controller.
    // Best way would be to wrap the UI code for each chart into their own
    // separate Angular Directive.  The Controller would take care of loading
    // the data and managing the events - mainly, updating the scope data
    // variables that each Directive then uses.  All the UI code would be
    // hidden behind the Directive's interface.
    // Just learning Angular, so staring with this initial implementation for 
    // now, hope to change in the future.
    // -------------------------------------------------------------------------
    // -------------------------------------------------------------------------      
    
  
    // -------------------------------------------------------------------------      
    // Create the Angular App - this is the root.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    
    // -------------------------------------------------------------------------      
    // Create Factory using our App.
    // Factory just wraps data retrieval method in this case.
    // -------------------------------------------------------------------------   
    var eimod = angular.module('eimodule',[]);
    eimod.factory("eifactory", function($http) {
      var factory = {};    
      
      factory.getRawData = function() {
        return $http.get('eidata.json');      
      };  
      
    return factory;      
    });

    // -------------------------------------------------------------------------      
    // Create Controller using our App.
    // Controller holds all the business logic.
    // Controller has access to a $scope variable where we can store state.
    // -------------------------------------------------------------------------   
    eimod.controller("ei_countrySelect_control", function($scope, eifactory) {
      
      console.log("in controller");
      
      // -------------------------------------------------------------------------      
      // Initialize variables that will hold our data.
      // These vars sit on the $scope variable so all angular functions have
      // access to them.
      // FYI country data has been split into three variables for ease of use
      // 1) non-time-series data
      // 2) macro time-series data
      // 3) resource-related time-series data
      // -------------------------------------------------------------------------      
  
      // raw form that data is read in from file
      $scope.raw_data = [];
      //$scope.country_names = [];      
      
      // associative array (ccode is key) of non-time series country data
      $scope.country_data_json = [];
      // associative array (ccode is key) of time series macroeconomic data
      $scope.country_macro_stat_data_json = [];
      // associative array (ccode is key) of time series resource-related data
      $scope.country_resource_stat_data_json = [];      
      // associative array (ccode is key) of time series resource-related data
      // where the time series data is in an array format, not a JS object one
      // this is the format the c3 charts expect
      // same data as "country_resource_stat_data_json"
      $scope.country_resource_stat_data_arr = [];
      // name of the currently selected country
      $scope.current_country_name = "";
      // object that holds the default fill information for each country on 
      // the map 
      $scope.dataMapFillKeys = {};
      
      $scope.currentStat = "default";
      $scope.currentStatName = "";
 
      // stores our map and chart visualization variables
      $scope.chart1 = null;      
      $scope.chart2 = null;
      $scope.levelsCompareChart = {};
      
      // array of years
      // this is necessary for the c3 charts
      var xaxis = ["x",2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012];
      
      // -------------------------------------------------------------------------      
      // This function is called when the JSON data has been loaded.
      // It does 2 things:
      // 1) Any needed data processing (before the page uses the dat).  Saves results
      //    in $scope variables declared above.
      // 2) Sets up & creates each chart, and saves the variable in $scope.
      // -------------------------------------------------------------------------            
       
      eifactory.getRawData().success(function(data) {
        
          console.log("in get data success");
  
          // save raw data
          $scope.raw_data = data;
          //console.log("raw data: ");
          //console.log($scope.raw_data);
          
    
          // take data out of raw data and puts into associative arrays
          // where it is easier for our charts to access          
          $scope.raw_data.forEach(function(countryObj, index) {
            $scope.country_data_json[countryObj.country.ccode] = countryObj.country;
            $scope.country_macro_stat_data_json[countryObj.country.ccode] = countryObj.macroStats;
            $scope.country_resource_stat_data_json[countryObj.country.ccode] = countryObj.resourceStats;            
          });           
          console.log("country json data: ");
          console.log($scope.country_data_json);  
          console.log("country macro stat json data: ");
          console.log($scope.country_macro_stat_data_json);  
          console.log("country resource stat json data: ");
          console.log($scope.country_resource_stat_data_json);  


          // this put the same resource data into array format
          // this is only necessary because c3 chart expects time series
          // data to come in this format.
          $scope.raw_data.forEach(function(countryObj, index) {
                       
            var statData = Object();
            $scope.country_resource_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(xaxis);
            
            for (var statname in countryObj.resourceStats) {
              //console.log(countryObj.resourceStats);
              //console.log(statname);
              var tmp=[];
              tmp.push(statname);
              statData[statname] = tmp.concat(countryObj.resourceStats[statname]);
              $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(statData[statname]);            
            }

          });
          console.log("country arr data: ");
          console.log($scope.country_resource_stat_data_arr);  
 
 
          // this creates the default fill keys for the map, based
          // on whether we have any resource data
          // this object will be passed to data map          
          for (countryObjKey in $scope.country_data_json) {
            $scope.dataMapFillKeys[countryObjKey] = {};
            if ($scope.country_data_json[countryObjKey].haveResourceStats == "1") {
              //console.log("has stats");
              $scope.dataMapFillKeys[countryObjKey].fillKey = "haveResourceStats";
            }  
            else   
              $scope.dataMapFillKeys[countryObjKey].fillKey = "defaultFill";  
          }
          console.log("dataMapFillKeys:");
          console.log($scope.dataMapFillKeys);
          
          $scope.group_resource_stat_data_json = {};
          $scope.group_resource_stat_data_arr = [];
          
                    
          // this calculates average data for groups of countries we are interested in
          // and stores it in an object
          var resourceStats = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          
          lookupfactors.forEach(function(currentFactor, index) {
              console.log("in lookup loop");
              console.log(currentFactor);
              
              // have to make a copy of currentFactor explicitly or Javascript will point to same ref
              $scope.group_resource_stat_data_json[currentFactor.factor] = new Object();
              $scope.group_resource_stat_data_json[currentFactor.factor]["factor"] = currentFactor.factor;
              $scope.group_resource_stat_data_json[currentFactor.factor]["name"] = currentFactor.name;
              $scope.group_resource_stat_data_json[currentFactor.factor]["color"] = currentFactor.color;              
              $scope.group_resource_stat_data_json[currentFactor.factor].levels = [];
              
              $scope.group_resource_stat_data_arr[currentFactor.factor] = [];  
              
              currentFactor.levels.forEach(function(currentLevel, index) {
                console.log("currentLevel.level");
                
                console.log(currentLevel.level);
                
                $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level] = currentLevel;
                $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level].stats = [];                
                
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level] = [];  
                $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(xaxis);  
                
                var countries = getCountriesInGroup($scope.country_data_json, currentFactor.factor, currentLevel.level); 
                //console.log(countries);
                
                resourceStats.forEach(function(currentStat, sindex) {
                  var timeseries = [];
                  //!! Coal
                  //if (countries == null)
                  
                  countries.forEach(function(currentCountry, iindex) {
                    timeseries.push($scope.country_resource_stat_data_json[currentCountry][currentStat])
                  });                          
                  var byyears = d3.transpose(timeseries);
                  var tmp=[];
                  tmp.push(currentStat);
                  byyears.forEach(function(currentYear, index){
                    tmp.push(d3.mean(currentYear));
                  });
                  $scope.group_resource_stat_data_json[currentFactor.factor].levels[currentLevel.level].stats[currentStat] = tmp;
                  $scope.group_resource_stat_data_arr[currentFactor.factor][currentLevel.level].push(tmp);                  
                });
              });                        
          });
          
          console.log("$scope.group_resource_stat_data_json");
          console.log($scope.group_resource_stat_data_json);
          console.log("$scope.group_resource_stat_data_arr");
          console.log($scope.group_resource_stat_data_arr);
                    
          $scope.current_selection_name = $scope.country_data_json[$scope.current_country_id]["name"];

      // -------------------------------------------------------------------------      
      // Create the c3 line chart for resource data
      // -------------------------------------------------------------------------      

          $scope.chart2 = c3.generate({
              
                  bindto: '#chart2',      
                  
                  size: {
                    height: 200,
                  },   
                  data: {
                    x: 'x',
                    columns: $scope.country_resource_stat_data_arr[$scope.current_country_id],
                    axes: { rev_gov_resrev_govtrev : 'y',calc_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_rev_gdp : 'y', calc_rent_total_gdp : 'y', calc_govt_take: 'y2' },
                    type: 'line',
                    types: {
                        calc_govt_take: 'area',
                    },
                    names: varnames, 
                    colors: varcolors, 
                    labels:false,
                  }, // data  
                  axis: {
                    y: {
                      max: 100,
                      min: 0,
                      padding: {top:0, bottom:5},
                      label: {
                        text: 'Percent',
                        position: 'outer-middle'
                      },                      
                    },
                    y2: { max: 1.4, 
                          min: 0, 
                          padding: {top:0, bottom:.2},
                          show: true,
                          label: {
                            text: 'Government Take Ratio',
                            position: 'outer-middle'
                          },
                        },
                    x: { min: 2000, max: 2011, 
                    }
                
                  }, // axis
              
                 legend: {
                    show: false
                  },
                  
          });// c3.generate
          
      // -------------------------------------------------------------------------      
      // Create the data map
      // -------------------------------------------------------------------------      
          
          console.log("width " + $("#chart1").parent().width());
          
          $scope.chart1 = new Datamap({
              element: document.getElementById('chart1'),
              scope: "world",
              fills: {
                defaultFill: "#eee", //#eee
                haveResourceStats: "#bebebe", //#faa632 //a65628 ffbb78 a65628 //#a6a6a6 dataAvailable bebebe
              },
              data: $scope.dataMapFillKeys,              
              "done": function(datamap) {
                  console.log("in done");
                  //$scope.datamap = datamap;
                  console.log($scope.datamap);
                  datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography, data) {
                    //console.log("in on click datamap");
                    $scope.selectCountry(geography.id);
                    //$scope.current_country_id = geography.id;
                    //$scope.$apply();
                  });
              }, // done
              geographyConfig: {
                highlightOnHover: true,
                highlightFillColor: '#ff7f0e',
                //highlightBorderColor: '#ff7f0e',
                //highlightBorderWidth: 5,
              },
         }); // chart1 
          
        
      // -------------------------------------------------------------------------      
      // Update map and groups at same time
      // For map, should really be doing this intially, not updating it...
      // have to change later.
      // -------------------------------------------------------------------------      
          
        console.log($scope.currentStat);
        //$scope.updateGroupStat($scope.currentStat);
        $scope.updateCurrentStat($scope.currentStat);
        
        $scope.doLegend();
        $scope.setupLevelsCompare("#incomeCompare", "class_income", "calc_govt_take");
        $scope.setupLevelsCompare("#regionCompare", "class_reg", "calc_govt_take");
        $scope.setupLevelsCompare("#rentCompare", "prim_rent", "calc_govt_take");
  
        $scope.setUpHeatmap("calc_govt_take");
        $scope.heatmap = new Heatmap("#heat2", xaxis.slice(1, xaxis.length-1));
        $scope.heatmap.setupData("calc_govt_take");
        $scope.heatmap.setupChart();
        $scope.heatmap.drawChart();
          
      }).error(function(err){
          throw(err);                     
      }); // getData


      // -------------------------------------------------------------------------      
      // "Listener" function that is called whenever the current_country_id is
      // changed.  When selection is made in datamap, datamap changes this variable
      // This updates the line chart
      // Have to check for nulls here becuase it is called right at the beginning,
      // before data is loaded
      // -------------------------------------------------------------------------                

    $scope.$watch('current_selection', function(newValue, oldValue) {
        console.log('watch current_selection newValue:');
        console.log(newValue);
        
        if ($scope.current_country_id == null) {
          var countries = getCountriesInGroup($scope.country_data_json, newValue.factor, newValue.level);
          if ($scope.chart1 != null) {
            $scope.selectOnMap(countries);
          } 
          if ($scope.group_resource_stat_data_json != null) {
            $scope.current_selection_name = newValue.level;          
          }
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.group_resource_stat_data_arr[newValue.factor][newValue.level] })
        } else {
          if ($scope.chart1 != null) $scope.selectOnMap(new Array(newValue));
        
          if ($scope.country_data_json[newValue] != null) {
            //console.log($scope.country_data_json[newValue]);
            $scope.current_selection_name = $scope.country_data_json[newValue]["name"];          
          }    
          if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.country_resource_stat_data_arr[newValue] });          
        }
    }, true); 
 

      // -------------------------------------------------------------------------      
      // These are Event functions that are called when the user clicks a button 
      // on the datamap to
      // highlight or fill by a different variable
      // -------------------------------------------------------------------------                

      $scope.doLegend = function() {
          var resourceStatNames = d3.keys($scope.country_resource_stat_data_json[$scope.current_country_id]);
          var resourceStatObjs = [];  
          
          resourceStatNames.forEach(function(stat, index) {
            var statObj = {};
            statObj.variable = stat;
            statObj.name = varnames[stat];
            statObj.color = varcolors[stat]; 
            statObj.selected = false;
            resourceStatObjs.push(statObj);
          });
          console.log("resourceStatObjs");
          console.log(resourceStatObjs);
        
          var width = $("#legend").width()
          console.log("width: " + width);
        
          //var resourceStatObjs = [2,4,5,6,7];  
                  
          //var svg = d3.selectAll("#legend").append("svg")
          var svg = d3.selectAll("#legend").append("svg")
            .attr("width", $("#legend").width())
            .attr("height", 100);            
          
          var currentselection = null;
          
          var legend = svg.selectAll("g")
            .data(resourceStatObjs)
              .enter().append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(0," + i * 14 + ")"; });
  
          legend.append("rect")
            .attr("x", 0)
            .attr("width", 10)
            .attr("height", 10)
            .style("fill", function(d,i) { return d.color; });
  
          legend.append("text")
              .attr("x", 14)
              .attr("y", 5)
              .attr("dy", ".35em")              
              .attr("id", function(d) { return "stat"; } )              
              .attr("class", "statunselected")              
              .text(function(d) { return d.name; })
              .on("click", function(d, i) { 
                  //console.log(d3.select(this).parentNode); 
                  //d.selected = true;
                  //currentSelection = d;
                  d3.selectAll("#stat").style("fill", "#bebebe");
                  //d3.selectAll("#stat").attr("class", "statunselected");
                  d3.select(this).style("fill", function(d) { return d.color; });
                  $scope.updateCurrentStat(d.variable);
              })
              /*
              .on("mouseover", function(d,i) {
                  //console.log(d.name);
                  if (!d.selected) d3.select(this).style("fill", "#ff7f0e");
              })   
              .on("mouseout", function(d,i) {
                  //console.log(d.name);
                  if (!d.selected) d3.select(this).style("fill", "#bebebe");
              });
              */
      }

      $scope.setupLevelsCompare = function(element, factor, stat) {
          
          //$scope.groupCompareChart = {};
          var chartData = [];
          chartData.push(xaxis);
          var levelnames = d3.keys($scope.group_resource_stat_data_json[factor].levels);
          
          levelnames.forEach(function(levelname, index) {
            //console.log("in levels");
            var tmp = [];
            tmp.push($scope.group_resource_stat_data_json[factor].levels[levelname].dname);
            tmp = tmp.concat($scope.group_resource_stat_data_json[factor].levels[levelname].stats[stat].slice(1));
            chartData.push(tmp);
          }); 
          console.log(chartData);    
          
          $scope.levelsCompareChart[element] = c3.generate({
                bindto: element,
                size: {
                    height: 200,
                  }, 
                data: {
                    x: 'x',
                    columns: chartData,
                    type: 'line',
                    names: varnames, 
                    //colors: varcolors, 
                    //labels:false,
                  }, // data
                axis: {
                    x: {
                        //type: 'timeseries',
                        tick: {
                        count: 2,
                        //format: '%Y'
                        }
                    }
                }  
            });  
      } 
      
      $scope.setUpHeatmap = function(stat, numrows) {
        // create the data objects with ID (ccode), stat(year or statistic), and value
        // then add a key function that returns the ccode
          var countries = d3.keys($scope.country_data_json).filter(function(ccode) { return $scope.country_data_json[ccode].haveResourceStats == "1";});          
          var rows = xaxis.slice(1, xaxis.length-1);        
 
          numrows = 12;
          var rows = d3.range(2000,2012);
 
          var margin = { top: 15, right: 0, bottom: 5, left: 50 },
          width = 1100 - margin.left - margin.right,
          height = 350 - margin.top - margin.bottom,
          gridSize = Math.floor(width / countries.length),
          legendElementWidth = gridSize*2;
          //buckets = 9;
          //colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"], // alternatively colorbrewer.YlGnBu[9]
        
        var chartData = [];
        countries.forEach(function(ccode, index) {
          rows.forEach(function(row, rindex) {
            var entry = new Object();
            entry.ccode = ccode;
            entry.row = rindex;            
            entry.value = $scope.country_resource_stat_data_json[ccode][stat][rindex];
            chartData.push(entry);              
          });  
        });
        
        console.log(chartData);
             
        var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[stat].lightColor, varlookup[stat].darkColor]); 
        var colorq = d3.range(.1, 1.1, .1);
        colorq = colorq.map(function (input) { return color(input); });
        console.log(colorq);

        var colorScale = d3.scale.quantize()
              .domain([d3.min(chartData, function (d) { return d.value; }), d3.max(chartData, function (d) { return d.value; })])
              .range(colorq);
  
        var padding = 2;
        //updateData(chartData);
          var data=d3.nest()
          .key(function(d) {return d.ccode;})
          .sortKeys(d3.ascending)
          .entries(chartData);
          
        console.log("data");
        console.log(data);
        
        var base = d3.select("#heatyear").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom);

        var years = base.append("g")
                .attr("transform", "translate(6," + (margin.top + 24) + ")")
                .selectAll("text")
                .data(rows)
                .enter()
                .append("text")
                .text(function (d) { return d; })
                .attr("x", 0)
                .attr("y", function(d,i) { return i*gridSize})
                .attr("class", "heatcountrylabel")              
                //.attr("transform", "rotate(-90)")              
                .style("text-anchor", "start")
                .on("click", function(d, i) { 
                      
                  
                });
  
        var svg = base.append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
              
      /*
        var svg = d3.select("#heatyear").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      */
      var countryg = svg.selectAll("g").data(data).enter()
                        .append("g")
                        .attr("transform",function(d,i) {return "translate(" + (gridSize*(i)) + ",0)" });
         countryg
          .append("text")
                .text(function (d) { return d.key; })
                .attr("x", 0)
                .attr("y", 0)
                .attr("class", "heatcountrylabel")              
                .attr("transform", "rotate(-90)")              
                .style("text-anchor", "middle");      
        countryg.selectAll("rect")
          .data(function(d) {return d.values}) 
          .enter()
              .append("rect")
              .attr("x", -gridSize + 2*padding)
              .attr("y", function(d,i) { return 10 + padding + (d.row * gridSize); })
              //.attr("class", "hour bordered")
              .attr("width", function(d,i) { return gridSize - padding; })
              .attr("height", function(d,i) { return gridSize - padding; })
              .style("fill", function(d,i) { return (d.value == null) ? "#ffffff" : colorScale(d.value); })
              // throwing in a title element
              .append("title")
                .text(function(d) {return d.value;}); 
                    
      var myint = setInterval(updateData,3000);
     
      function updateData() {
          console.log("updating");
        
          function doSort(a, b) {
          
          var nestdata = chartData.filter(function (elem, index) { return elem.row == 0; });
          
          //console.log("nestdata");
          //console.log(nestdata);
                    
          //console.log(a);
          //console.log(b);
          
          var nestData2 = [];
          nestdata.forEach(function(elem, index) {
            nestData2[elem.ccode] = elem.value;                  
          });
          
          if (nestData2[a] == null && nestData2[b]) return 0;
          if (nestData2[a] == null) return 1;
          if (nestData2[b] == null) return -1;
                    
          if (nestData2[a] > nestData2[b]) return -1;
          if (nestData2[a] < nestData2[b]) return 1;
          return 0;                    
        }
        
        var data=d3.nest()
          .key(function(d) {return d.ccode;})
          .sortKeys(function(a,b) { return doSort(a,b); }) 
          .entries(chartData);
        console.log("data");        
        console.log(data);  
            
        var update = svg.selectAll("g").data(data, function(d) { return d.key; });
        console.log(update);
        //update selection          
        update.transition()
          .duration(1000)
          .attr("transform",function(d,i) { return "translate(" + (gridSize*(i)) + ",0)" });
        clearInterval(myint);
      
      }  
      
      }

      $scope.selectCountry = function(country) {
        console.log("selecting country:" + country);
        $scope.current_country_id = country;
        $scope.current_group_id = null;
        $scope.current_selection = country;        
        $scope.$apply();        
      }
      $scope.selectGroup = function(group, value) {
        console.log("selecting group:" + group + " with value: " + value);
        $scope.current_country_id = null;
        $scope.current_group_id = {"factor": group, "level": value };
        $scope.current_selection = {"factor": group, "level": value };
       } // end ftn   
              
      $scope.selectOnMap = function(countries) {
        console.log("selecting countries");
        
        var svg = $scope.chart1.svg;
        
        for (countryObjKey in $scope.country_data_json) {
          svg
              .selectAll('.' + countryObjKey)
              .classed({'plainpaths':true,'grouppaths':false });  
        }
        countries.forEach(function(country, index) {
            svg
              .selectAll('.' + country)
              .classed({'plainpaths':false,'grouppaths':true });        
        });
      }
      
      
      $scope.updateCurrentStat = function(statName) {
        console.log("updating choro");
        
        if(statName == "default") {
          $scope.chart1.updateChoropleth($scope.dataMapFillKeys);
          //$scope.updateGroupStat(statName);
        }           
          else {
          $scope.currentStat = statName;
          $scope.currentStatName = varnames[statName];
          //$scope.updateGroupStat(statName);
            
          var countryVals = {};
          countryVals = getTimeSeriesAverage($scope.currentStat);
          
          var vals = [];
          for(key in countryVals) {
            vals.push(countryVals[key]);
          }            
          
          /*
          var baseColor = d3.rgb(varcolors[statName]);
          var darkest = baseColor.darker().darker().darker();
          var lightest = baseColor.brighter().brighter().brighter();
          console.log(darkest.toString());
          console.log(lightest.toString());
          
         
     */
          
                              
          var color = d3.scale.linear()
                       .domain([d3.min(vals),d3.max(vals)])
                       .range([varlookup[statName].lightColor, varlookup[statName].darkColor]); //faa632 #ffbb78 b28254
         
          var chloroVals = {};
          for(key in countryVals) {
            //console.log("Key" + key + " is = " + countryVals[key]);
            //console.log("color" + ": " + color(countryVals[key]));
            
            if (countryVals[key] == null) {
                chloroVals[key] = "#eee";
            }
            else
                chloroVals[key] = color(countryVals[key]);
          }
          $scope.chart1.updateChoropleth(chloroVals);
        }
        if ($scope.heatmap != null) $scope.heatmap.updateChart(statName, 0);
      };

      // -------------------------------------------------------------------------      
      // Heatmap Object
      // -------------------------------------------------------------------------                

      // call it like this var a = new Heatmap("calc_govt_take", xaxis.slice(1, xaxis.length-1))
      // call it like this var a = new Heatmap("calc_govt_take", d3.range(2000,2012))
      

      Heatmap = function(element, rowlabels) {
        this.stat = null;
        this.rowlabels = rowlabels;        
        this.numrows = rowlabels.length;
        this.numcountries = null;
        this.countries = [];
        this.chartData = [];
        this.data = [];
        this.gridSize = null;
        
        this.element = element;
        this.colorScale = {};
        
        this.svg = {};
        this.countryg = {};
        
        this.countries = d3.keys($scope.country_data_json).filter(function(ccode) { return $scope.country_data_json[ccode].haveResourceStats == "1";});          
        this.numcountries = this.countries.length;
        
        this.margin = { top: 15, right: 0, bottom: 5, left: 50 };
        this.width = 1100 - this.margin.left - this.margin.right;
        this.height = 350 - this.margin.top - this.margin.bottom;
        this.gridSize = Math.floor(this.width / this.numcountries),
        this.legendElementWidth = this.gridSize*2;       
        this.padding = 2;
 
          
        //this.setupData();
        //this.setupChart();
        //this.drawChart();
        
        
        this.setupData = function(whichstat) {
          this.chartData = [];
          this.stat = whichstat;
          this.countries.forEach(function(ccode, index) {
            this.rowlabels.forEach(function(row, rindex) {
              var entry = new Object();
              entry.ccode = ccode;
              entry.row = rindex;            
              entry.value = $scope.country_resource_stat_data_json[ccode][whichstat][rindex];
              this.chartData.push(entry);              
            }, this);  
          }, this);       
          console.log("this.chartData");
          console.log(this.chartData);
  
          this.sortData(0);
        };
      
      this.setupChart = function() {
              
        console.log("setupChart gridSize " + this.gridSize);
        
        var color = d3.scale.linear()
                       .domain([0,1])
                       .range([varlookup[this.stat].lightColor, varlookup[this.stat].darkColor]); 
        var colorq = d3.range(.1, 1.1, .1);
        colorq = colorq.map(function (input) { return color(input); });
        
        //console.log(colorq);
        this.colorScale = d3.scale.quantize()
              .domain([d3.min(this.chartData, function (d) { return d.value; }), d3.max(this.chartData, function (d) { return d.value; })])
              .range(colorq);
      };
      
      this.drawChart = function() {
        
        var chart = this;
        
        var localgridsize = this.gridSize;
        var padding = this.padding;
        var cs = this.colorScale;

        var container = d3.select(this.element).append("svg")
            .attr("width", this.width + this.margin.left + this.margin.right)
            .attr("height", this.height + this.margin.top + this.margin.bottom);
              
        console.log(this.gridSize);
        var labels = container.append("g")
            .attr("transform", "translate(6," + (this.margin.top + 24) + ")")
            .selectAll("text")
            .data(this.rowlabels)
            .enter()
            .append("text")
            .text(function (d) { return d; })
            .attr("x", 0)
            .attr("id", function (d,i) { return i; })
            .attr("y", function(d,i) { console.log("gridSize " + localgridsize);console.log("i " + i); return i*localgridsize})
            .attr("class", "heatcountrylabel")              
            //.attr("transform", "rotate(-90)")              
            .style("text-anchor", "start")
            .on("click", function(d, i) { 
              container.selectAll(".heatcountrylabel").style("fill", "#bebebe");
              d3.select(this).style("fill", "#000000");
              chart.updateChart(null,i);              
            }); 
        this.svg = container.append("g")
            .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");            
              
        this.countryg = this.svg.selectAll("g").data(this.data).enter()
            .append("g")
            .attr("transform",function(d,i) {return "translate(" + (localgridsize*(i)) + ",0)" });
        this.countryg
            .append("text")
              .text(function (d) { return d.key; })
              .attr("x", 0)
              .attr("y", 0)
              .attr("class", "heatcountrylabel")              
              .attr("transform", "rotate(-90)")              
              .style("text-anchor", "middle");      
        this.countryg
              .selectAll("rect")
              .data(function(d) {return d.values}) 
              .enter()
                  .append("rect")
                  .attr("x", -this.gridSize + 2*padding)
                  .attr("y", function(d,i) { return 10 + padding + (d.row * localgridsize); })
                  //.attr("class", "hour bordered")
                  .attr("width", function(d,i) { return localgridsize - padding; })
                  .attr("height", function(d,i) { return localgridsize - padding; })
                  .style("fill", function(d,i) { return (d.value == null) ? "#ffffff" : cs(d.value); })
                  // throwing in a title element
                  .append("title")
                    .text(function(d) {return d.value;});                   
      };
      
      this.sortData = function(whichrow) {
        var chart = this;
         this.data=d3.nest()
          .key(function(d) {return d.ccode;})
          .sortKeys(function(a,b) { return chart.doSort(a,b, whichrow); }) 
          .entries(this.chartData);
        console.log("data");        
        console.log(this.data);         
      };
        
      this.updateChart = function(whichstat, whichrow) {
        var chart = this;
        var localgridSize = this.gridSize;
        
        if (whichstat == null) {
          this.sortData(whichrow);  
          
          console.log("this.data in update whichrow");
          console.log(this.data);
          
          var update = this.svg.selectAll("g").data(this.data, function(d) { return d.key; });
          console.log(update);
          //update selection          
          update.transition()
            .duration(1000)
            .attr("transform",function(d,i) { return "translate(" + (localgridSize*(i)) + ",0)" });
          //clearInterval(myint);
        } else {
          this.setupData(whichstat);
          this.setupChart();
          this.sortData(whichrow);
          
          console.log("this.data in update whichstat");
          console.log(this.data);
          
          var rects = this.svg.selectAll("g").data(this.data, function(d) { return d.key; })
            .selectAll("rect")
            .data(function(d) { console.log(d); return d.values}, function(d) { return d.row; })
                .style("fill", function(d,i) { console.log("filling: " + d); return (d.value == null) ? "#ffffff" : chart.colorScale(d.value); });
      
          var titles = this.svg.selectAll("g").data(this.data, function(d) { return d.key; })
            .selectAll("title")
            .data(function(d) { console.log(d); return d.values}, function(d) { return d.row; })
                    .text(function(d) {return d.value;},function(d) { return d.row; });                
          
          var update = this.svg.selectAll("g").data(this.data, function(d) { return d.key; });
          //console.log(update);
          //update selection          
          update.transition()
            .duration(1000)
            .attr("transform",function(d,i) { return "translate(" + (chart.gridSize*(i)) + ",0)" });
//              .selectAll("rect")
//                .data(function(d) {console.log(d); return d.values}, function(d) { return d; }) 
//                .style("fill", function(d,i) { return (d.value == null) ? "#ffffff" : chart.colorScale(d.value); });
          //clearInterval(myint);
          
        }        
      }; // updateChart  
      
      this.doSort = function(a, b, whichrowindex) {

          var nestdata = this.chartData.filter(function (elem, index) { return elem.row == whichrowindex; });          
          var nestData2 = [];
          
          nestdata.forEach(function(elem, index) {
            nestData2[elem.ccode] = elem.value; 
          });

          if (nestData2[a] == null && nestData2[b] == null) return 0;
          if (nestData2[a] == null) return 1;
          if (nestData2[b] == null) return -1;
                    
          if (nestData2[a] > nestData2[b]) return -1;
          if (nestData2[a] < nestData2[b]) return 1;
          return 0;                          
      }; // doSort
      
      } // HEatmap


      // -------------------------------------------------------------------------      
      // Helper functions to manage user clicks.
      // -------------------------------------------------------------------------                

      function getTimeSeriesAverageByCountry(ccode, statname) {
        //console.log("getting avg" + statname);
        //console.log($scope.country_macro_stat_data_json[ccode]);
        if ($scope.country_macro_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_macro_stat_data_json[ccode][statname]);    
        }  
        else if ($scope.country_resource_stat_data_json[ccode][statname]) {
          return d3.mean($scope.country_resource_stat_data_json[ccode][statname]);                    
        }
        else 
          return null;            
      };              
      
      function getTimeSeriesAverage(statName) {
        var statData = {};
        for (countryObjKey in $scope.country_data_json) {
          statData[countryObjKey] = getTimeSeriesAverageByCountry(countryObjKey, statName);    
        }
        console.log(statData);
        return statData;
      };
              
      function getCountriesInGroup(data, group, value) {
        console.log("Getting countries in " + group + " that are " + value);
        var out = [];
        //console.log(d3.keys(data));
        var keys = d3.keys(data);
        
        keys.forEach(function(ccode, index) {
          //console.log(ccode);
          //console.log(data[ccode]);
          //console.log(data[ccode][group]);
          if(data[ccode][group] == value) out.push(ccode);
        });
        //console.log(out);
        return out;
      }
      
    }); // controller
    
    </script>
    
    <script>
    
      // ----------------------------------------------------------------------      
      // I would like to load this separately from a JSON file, but don't know
      // how to do two seperate JSON files.  For now I will put these
      // constants here.
      // ----------------------------------------------------------------------                
    
      console.log("loading lookup constants for variables");
      var varlookupvals = 
        [ {
           "variable": "calc_gov_resrev_gdp",
          "values": {
           "name": "Government Resource Revenue",
          "source": "Calculated: avg of REV$rev_gov_resrev_gdp and REV2$rev2_gov_resrev_gdp",
          "color": "1f77b4",
          } 
          },{
           "variable": "calc_govt_take",
          "values": {
           "name": "Government Take",
          "source": "Calculated: calc_gov_resrev_gdp / calc_rent_total_gdp",
          "color": "8c564b", //#a6a6a6 ff7878 8c564b
          } 
          },{
           "variable": "econ_gdpcon",
          "values": {
           "name": "GDP (constant $)",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_gdpconpc",
          "values": {
           "name": "GDP per capita (constant $)",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_govexp",
          "values": {
           "name": "Government Expenditure",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_govrev",
          "values": {
           "name": "Government Revenue",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_invtotal",
          "values": {
           "name": "Value of Investments",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "econ_tax",
          "values": {
           "name": "Government Tax Revenue",
          "source": "Economic_Indicators ",
          "color": "" 
          } 
          },{
           "variable": "calc_rent_total_gdp",
          "values": {
           "name": "Total Rents",
          "source": "Calculated from RENT: sum of RENT$rent_min, RENT$rent_oil, RENT$rent_gas",
          "color": "d62728" 
          } 
          },{
           "variable": "rev_gov_resrev_gdp",
          "values": {
           "name": "Government Resource Revenue",
          "source": "Resource_Revenue",
          "color": "" 
          } 
          },{
           "variable": "rev_gov_resrev_govtrev",
          "values": {
           "name": "Government Resource Revenue as % Govt Rev",
          "source": "Resource_Revenue",
          "color": "2ca02c" 
          } 
          },{
           "variable": "rev2_gov_nonresrev_gdp",
          "values": {
           "name": "Government Non-Resource Revenue",
          "source": "Resource_Revenue2",
          "color": "9467bd" //9467bd 1f77b4
          } 
          },{
           "variable": "rev2_gov_resrev_gdp",
          "values": {
           "name": "Government Resource Revenue",
          "source": "Resource_Revenue2",
          "color": "" 
          } 
          },{
           "variable": "rev2_gov_rev_gdp",
          "values": {
           "name": "Total Government Revenue",
          "source": "Resource_Revenue2",
          "color": "bcbd22" //8c564b bcbd22
           }
           }
           /*
           ,{
           "variable": "class_income",
          "values": {
           "name": "Income Level",
          "source": "CountryClassification",
          "color": "" //9467bd 1f77b4
          } 
          },{
           "variable": "class_reg",
          "values": {
           "name": "Region",
          "source": "CountryClassification",
          "color": "" 
          } 
          },{
           "variable": "prim_prod",
          "values": {
           "name": "Primary Resource Produced",
          "source": "Production_Total",
          "color": "" //8c564b bcbd22
          }
          },{
           "variable": "prim_rent",
          "values": {
           "name": "Primary Rent Source",
          "source": "Rent",
          "color": "" //8c564b bcbd22
          }          
        }*/ ];

        
        var varnames = {};
        var varcolors = {};
        var varlookup = {};

        //var c = d3.scale.category10();
        //var dataAvailable = c(0);
        var dataAvailable = "#ffbb78";
        varlookupvals.forEach(function(item, index) {
          //console.log(item);
          varnames[item.variable] = item.values.name;
          varcolors[item.variable] = "#".concat(item.values.color);
          varlookup[item.variable] = item.values;
          
          if (varcolors[item.variable] != "#") {            
            var baseColor = d3.rgb(varcolors[item.variable]);
            var darkest = baseColor.darker().darker().darker();
            var lightest = baseColor.brighter().brighter().brighter();
            //console.log(darkest.toString());
            //console.log(lightest.toString());
            
            varlookup[item.variable]["lightColor"] = lightest.toString();
            varlookup[item.variable]["darkColor"] = darkest.toString();
          }
      }); 
      
      varlookup["calc_govt_take"].lightColor = "#dcccc9";
      varlookup["calc_govt_take"].darkColor = "#54332d";
      varlookup["calc_gov_resrev_gdp"].lightColor = "#bbd6e8";
      varlookup["calc_gov_resrev_gdp"].darkColor = "#12476c";
      varlookup["calc_rent_total_gdp"].lightColor = "#f2bebe";
      varlookup["calc_rent_total_gdp"].darkColor = "#951b1c";
    
      console.log(varlookup);
        
        var lookupfactors = [
          {
            "factor": "class_income",
            "name": "Income",
            "color": "",
            "levels": [ 
              { "level": "Low income", "dname":"Low", "code": "LINC" },
              { "level": "Lower middle income", "dname":"Lower Middle", "code": "LMINC" },
              { "level": "Upper middle income", "dname":"Upper Middle", "code": "UMINC" },
              { "level": "High income", "dname":"High", "code": "HINC" },   
            ]
          },
          {
            "factor": "class_reg",
            "name": "Region",
            "color": "",
            "levels": [ 
              { "level": "Africa", "dname":"Africa", "code": "AFR" },
              { "level": "Asia", "dname":"Asia", "code": "ASIA" },
              { "level": "Europe", "dname":"Europe", "code": "EUR" },
              { "level": "Latin America and the Caribbean", "dname":"LAmer.&Carr.", "code": "LAMERC" },   
              { "level": "North America", "dname":"NAmerica", "code": "NAMER" },   
              { "level": "Oceania", "dname":"Oceania", "code": "OCA" },   
            ]
          },
          {
            "factor": "prim_rent",
            "name": "Main Rent Source",
            "color": "",
            "levels": [ 
              { "level": "Oil", "dname":"Oil", "code": "OIL" },
              { "level": "Gas", "dname":"Gas", "code": "GAS" },
              { "level": "Coal", "dname":"Coal", "code": "COAL" },   
              { "level": "Minerals", "dname":"Minerals", "code": "MIN" },
            ]
          },
          {
            "factor": "class_opec",
            "name": "OPEC",
            "color": "",
            "levels": [ 
              { "level": "OPEC", "dname":"Member", "code": "OPEC" },
              { "level": "Non-OPEC", "dname":"Non-Member", "code": "NOPEC" },
            ]
          },         
        ];
        
        console.log("lookupfactors");                
        console.log(lookupfactors);
        //console.log(c("calc_govt_take"));
        
      
    </script>

  </body>
</html>